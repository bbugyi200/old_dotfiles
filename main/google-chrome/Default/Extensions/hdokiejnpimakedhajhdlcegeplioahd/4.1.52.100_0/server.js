function lplogincheck2(e,t,a,r){if(console_log("server.js : lplogincheck fromwebsite="+e+" sessionid="+t),!skiplogin()){can_chrome_do_math()||openURL(getchromeurl("mathfail.html")),yubikey_cleardata(),googleauth_cleardata(),outofband_cleardata(),securityquestion_cleardata(),sesame_cleardata(),grid_cleardata(),multifactor_cleardata(),loginoffline(!0,"logincheck");var o="canexpire=1&cansetuuid=1&method="+encodeURIComponent(get_method())+"&version="+lpversion;o+=get_devicetype_param(),t&&(o+="&sessionid="+LP.en(t)),a&&(o+="&wxusername="+LP.en(a)),r&&(o+="&wxhash="+LP.en(r)),isDogfood()&&(o+="&dogfood=1"),g_lastpoll=lastlogin=(new Date).getTime();var n=1==lpGetPref("logoffWhenCloseBrowser",0)&&0==lpGetPref("logoffWhenCloseBrowserVal",0)?"1":"0";o+="&sessonly="+en(n),console_log("logincheck getting uuid"),getuuid(function(t){if(console_log("logincheck got uuid"),"object"==typeof t){var a=0;for(var r in t)o+="&uuid"+a+"="+en(t[r]),++a}else o+="&uuid="+en(t);sesame_setdata("logincheckpostdata",o),lpdbg("login","Making login check request"),lpMakeRequest(base_url+"login_check.php",o,lpLoginCheckResponse,lpLoginCheckError,e)},g_username_hash)}}function lplogincheck(e,t,a,r){lplogincheck2(e,t,a,r)}function LP_do_login(e,t,a,r,o,n,s,i,l){function g(){Topics.get(Topics.LOGIN_FINISHED).unsubscribe(g),l&&l()}function u(a){getBG().make_lp_key_hash_iterations(a,t,get_key_iterations(e),function(e,t){localStorage_setItem("LPMPU",p),protect_data(t,!0,null,function(e){localStorage_setItem(p+"LPMPH",e)})})}if(!skiplogin()){if(!s)return void make_lp_key_iterations(e,t,get_key_iterations(e),function(s){LP_do_login(e,t,a,r,o,n,s,i,l)});if(l&&Topics.get(Topics.LOGIN_FINISHED).subscribe(g),lppassusernamehash&&!lploggedin&&lpnp_notify("login",{data0:e,data1:t}),!o){var d=opendb();if(createSavedLoginsTable(d),d&&void 0!==a&&null!=a){var c=r?t:"";protect_data(c,!1,e,function(t){if(a&&check_email(e)){var r=t!=c?1:0;r||""==c||(t=lpenc(t,AES.hex2bin(SHA256(e))),r=2),console_log("server.js : saving login credentials");var o=(new Date).getTime();g_indexeddb?d.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put({username:e,password:t,last_login:o,protected:r}):d.transaction(function(a){a.executeSql("REPLACE INTO LastPassSavedLogins2 (username, password, last_login, protected) VALUES(?, ?, ?, ?)",[e,t,o,r],function(e,t){},function(e,t){console_log(t)})})}else g_indexeddb?d.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").delete(e):d.transaction(function(t){t.executeSql("DELETE FROM LastPassSavedLogins2 WHERE username=?",[e],function(e,t){},function(e,t){console_log(t)})})})}void 0!==a&&null!=a&&(lpPutGblPref("rememberemail",a?1:0),lpPutGblPref("rememberpassword",r?1:0)),void 0!==n&&lpPutGblPref("showvault",n?1:0),lpWriteAllPrefs()}yubikey_cleardata(),googleauth_cleardata(),outofband_cleardata(),securityquestion_cleardata(),sesame_cleardata(),grid_cleardata(),o||multifactor_cleardata(),e=fix_username(e);var _=get_key_iterations(e);g_local_key=s||make_lp_key_iterations(e,t,_),"string"==typeof t&&t.length&&calculateMasterStrength(e,t),g_local_hash=lphash=i||make_lp_hash_iterations(g_local_key,t,_),g_local_key_hex=AES.bin2hex(g_local_key),g_local_key_hash=SHA256(g_local_key),g_username=lpusername=e,g_username_hash=lpusername_hash=SHA256(g_username),g_retryusername=g_username;var p=SHA256(e),f=localStorage_getItem(p+"LPMPS");null==f?(f=get_random(1e4,9999999).toString(36)+get_random(1e4,9999999).toString(36),u(f),protect_data(f,!0,null,function(e){localStorage_setItem(p+"LPMPS",e)})):unprotect_data(f,!0,u),lploggedinoffline||loginoffline(!0,"pluginlogin");var m="canexpire=1&cansetuuid=1&xml=2&username="+en(e)+"&method="+encodeURIComponent(get_method())+"&hash="+en(g_local_hash)+"&version="+lpversion;m+=get_devicetype_param(),m+="&encrypted_username="+en(lpenc(g_username,null,!0)),console_log("login getting uuid"),getuuid(function(a){console_log("login got uuid"),m+="&uuid="+en(a),m+="&lang="+en(lpGetPref("language",navigator.language));var r=get_key_iterations(e);if(m+="&iterations="+en(r),""!=r&&parseInt(r)>1){var n=checkNeedsPBKDF2v2(e,t);m+=n,""!=n&&"undefined"!=typeof g_oldpbkdf2&&1==g_oldpbkdf2&&(m+="&fallback=1")}var s=1==lpGetPref("logoffWhenCloseBrowser",0)&&0==lpGetPref("logoffWhenCloseBrowserVal",0)?"1":"0";m+="&sessonly="+en(s),sesame_cleardata(),sesame_setdata("postdata",m),sesame_setdata("from","login"),yubikey_cleardata(),yubikey_setdata("postdata",m),yubikey_setdata("from","login"),g_iterpw=t,googleauth_cleardata(),googleauth_setdata("postdata",m),googleauth_setdata("from","login"),outofband_cleardata(),outofband_setdata("postdata",m),outofband_setdata("from","login"),securityquestion_cleardata(),securityquestion_setdata("postdata",m),securityquestion_setdata("from","login"),grid_cleardata(),grid_setdata("postdata",m),grid_setdata("from","login"),o||multifactor_cleardata(),multifactor_setdata("postdata",m),multifactor_setdata("from","login"),m+="&otp=",m+="&sesameotp=",m+="&multifactorresponse=",GetOTPHash(m)},g_username_hash)}}function loginoffline(e,t){if(console_log("server.js : loginoffline from="+t+" offline_before_online="+e),!skiplogin())if(null==g_local_key||null==g_username||null==g_username_hash){if("frompipes"==t)return;get_saved_logins(function(a){var r="",o="",n=function(a){if((!LPISLOC||!LPISUPEK)&&r.length>0&&a.length>0){g_username=lpusername=r.toLowerCase().replace(/\s*/g,""),g_username_hash=lpusername_hash=SHA256(r);var o=get_key_iterations(g_username);return void make_lp_key_iterations(g_username,a,o,function(r){g_local_key=r,g_local_hash=lphash=make_lp_hash_iterations(g_local_key,a,o),g_local_key_hex=AES.bin2hex(g_local_key),g_local_key_hash=SHA256(g_local_key),loginoffline1(e,t)})}};if(a.length>0){if(r=a[0].username,o=a[0].password,1==a[0].protected)return void unprotect_data(o,!1,n);if(2==a[0].protected)return void n(lpdec(o,AES.hex2bin(SHA256(r))));n(o)}lpdbg("login","Trying to log in offline1: skipping because we dont have the user's key")})}else loginoffline1(e,t)}function read_key_from_file(e){if(have_binary_function("read_file"))return void call_binary_function("read_file",db_prepend(g_username_hash+"_lpall.slps"),function(t){"string"!=typeof t?e(""):unprotect_data(t,!0,e)});e("")}function read_accts_from_file(e){have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lps.act.sxml"),function(t){"string"!=typeof t?e(""):unprotect_data(t,!0,function(t){if("iterationserror"==(t=checkIterationsInDataFile(t)))return lpdbg("login","Key iterations mismatch"),void e("");t=lpdec(t),e(t)})}):e("")}function loginoffline1(e,t,a){if(console_log("server.js : loginoffline1 offline_before_online="+e+" from="+t),e){if(g_loggedinoffline)return;console_log("server.js : DB:opening database");var r=opendb();if(console_log("server.js : DB:opened database db="+r),createDataTable(r),r){console_log("server.js : DB:created database");var o=function(r,o){if(console_log("server.js : DB:inside transaction A"),2!=o.rows.length)return console_log("server.js : DB:inside transaction B"),LPISLOC&&(!LPISUPEK||a||""==g_username||AES.hex2bin(SHA256(g_username+""))==g_local_key?lpshowError("LoginError",!1,!0):(g_pwdeckey=g_local_key,lpWriteKeyFile(),g_local_accts_version=0,LPISUPEK&&(g_prompts.login_site_prompt=!0,g_prompts.edit_site_prompt=!0,g_prompts.edit_sn_prompt=!0,g_prompts.view_pw_prompt=!0,g_prompts.view_ff_prompt=!0,g_prompts.switch_identity_prompt=!0,g_prompts.switch_f_prompt=!0,g_prompts.multifactor_reprompt=!0),rewritelocalfile(),loginoffline1(e,t,!0))),console_log("server.js : DB:inside transaction C"),void lpdbg("login","Trying to log in offline : offline before online failed : could not read keyfile or accts");console_log("server.js : DB:inside transaction D");var n="key"==o.rows.item(0).type?0:1,s=o.rows.item(n).data,i=!1,l=s.split("\n");if(2==l.length){"lastpass rocks"==lpdec(l[1],g_local_key)&&(console_log("server.js : DB:inside transaction E"),i=!0)}return i?(console_log("server.js : DB:inside transaction G"),n="accts"==o.rows.item(0).type?0:1,s=o.rows.item(n).data,s=s.substring(0,220),"iterationserror"==(s=checkIterationsInDataFile(s))?void lpdbg("login","Key iterations mismatch, bailing on loginoffline"):s.indexOf("type=sesameoffline\ndata=")>=0||s.indexOf("type=yubikeyoffline\ndata=")>=0||s.indexOf("type=trueapioffline\ndata=")>=0||s.indexOf("type=omnikeyoffline\ndata=")>=0?(console_log("server.js : DB:inside transaction H"),void lpdbg("login","Data is encoded with multifactor key, bailing on loginoffline")):(console_log("server.js : DB:inside transaction I"),offlineloginsuccessful(t,!0),lpdbg("login","Trying to log in offline : offline before online successful"),void 0)):(console_log("server.js : DB:inside transaction F"),LPISLOC&&lpshowError("LoginError",!1,!0),void lpdbg("login","Trying to log in offline: skipping because we have an incorrect user's key"))},n=function(e,t){lpdbg("login","Trying to log in offline3: skipping because we dont have the user's key")};if(LPISLOC)read_key_from_file(function(e){read_accts_from_file(function(t){""!=e||""!=t?o(tx,{rows:{length:2,item:function(a){return 0==a?{type:"key",data:e}:{type:"accts",data:t}}}}):o(tx,{rows:{length:0}})})});else if(g_indexeddb){var s={rows:{item:function(e){return this[e]},length:0}};r.transaction("LastPassData","readonly").objectStore("LastPassData").index("username_hash").openCursor(IDBKeyRange.only(db_prepend(g_username_hash))).onsuccess=function(e){var t=e.target.result;t?("key"!=t.value.type&&"accts"!=t.value.type||(s.rows[s.rows.length]=t.value,s.rows.length++),t.continue()):o(null,s)}}else r.transaction(function(e){e.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND (type=? OR type=?)",[db_prepend(g_username_hash),"key","accts"],o,n)})}else console_log("server.js : DB:failed to create database db="+r)}else if(!g_loggedinoffline){var r=opendb();if(createDataTable(r),r){var o=function(e,a){if(2!=a.rows.length)return void lpdbg("login","Trying to log in offline : offline before online failed : could not read keyfile or accts");var r="key"==a.rows.item(0).type?0:1,o=a.rows.item(r).data,n=!1,s=o.split("\n");if(2==s.length){"lastpass rocks"==lpdec(s[1],g_local_key)&&(n=!0)}if(!n)return void lpdbg("login","Trying to log in offline: skipping because we have an incorrect user's key");if(r="accts"==a.rows.item(0).type?0:1,o=a.rows.item(r).data,o=o.substring(0,220),"iterationserror"==(o=checkIterationsInDataFile(o)))return void lpdbg("login","Trying to log in offline: skipping because we have a key iterations mismatch");if(o.indexOf("type=sesameoffline\ndata=")>=0)return lpdbg("sesame","Logging in offline and existing file is protected by sesameoffline => asking user for offline password"),sesame_setdata("offline",1),void sesame_getotp(null);if(o.indexOf("type=trueapioffline\ndata=")>=0||o.indexOf("type=omnikeyoffline\ndata=")>=0){lpdbg("multifactor","Logging in offline and existing file is protected by trueapioffline => asking user for offline password");var i=o.indexOf("type=trueapioffline\ndata=")>=0?"trueapi":"omnikey";return multifactor_setdata("offline",1),multifactor_setdata("type",i),void multifactor_getresponse(g_username)}if(o.indexOf("type=yubikeyoffline\ndata=")>=0)return yubikey_setdata("offline",1),void yubikey_getotp(null);offlineloginsuccessful(t,!1),lpdbg("login","Trying to log in offline : offline after online successful")};if(LPISLOC)read_key_from_file(function(e){read_accts_from_file(function(t){""!=e||""!=t?o(tx,{rows:{length:2,item:function(a){return 0==a?{type:"key",data:e}:{type:"accts",data:t}}}}):o(tx,{rows:{length:0}})})});else if(g_indexeddb){var s={rows:{item:function(e){return this[e]},length:0}};r.transaction("LastPassData","readonly").objectStore("LastPassData").index("username_hash").openCursor(IDBKeyRange.only(db_prepend(g_username_hash))).onsuccess=function(e){var t=e.target.result;t?("key"!=t.value.type&&"accts"!=t.value.type||(s.rows[s.rows.length]=t.value,s.rows.length++),t.continue()):o(null,s)}}else r.transaction(function(e){e.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND (type=? OR type=?)",[db_prepend(g_username_hash),"key","accts"],o)})}}}function offlineloginsuccessful(e,t){console_log("server.js : offlineloginsuccessful beforeonlineattempt="+t+" from="+e),LPISLOC&&"pluginlogin"==e&&g_manual_login&&(1==lpGetPref("showvault",g_showvaultdefault)||g_showvaultalways)&&(console_log("server.js : offlineloginsuccessful openvault offline version!"),openvault(1)),console_log("server.js : offlineloginsuccessful!"),g_loggedinonline||(g_loggedinoffline=!0);try{LPContentScriptFeatures=JSON.parse(localStorage_getItem(g_username_hash+".lpfeatures"))||{}}catch(e){LPContentScriptFeatures={}}lploggedin=!0,lpReadAllPrefs(function(){drawIconAtRotation(0)}),loggedIn("pluginlogin"==e),console_log("RSA : offlineloginsuccessful : calling readrsaprivatekeyhexfromdb()"),readrsaprivatekeyhexfromdb(),"offline"!=e&&(console_log("server.js : offlineloginsuccessful : from "+e+" so calling get_accts_local!"),get_accts_local(!0)),g_notifytimerid&&(clearTimeout(g_notifytimerid),g_notifytimerid=null);var a=t?3e4:0;g_notifytimerid=setTimeout(function(){notifyoffline(e)},a),g_retryonlinetimerid&&(clearTimeout(g_retryonlinetimerid),g_retryonlinetimerid=null);g_retryonlinetimerid=setTimeout(function(){retryonlinelogin(3e4)},3e4)}function notifyoffline(e){console_log("server.js : notifyoffline from="+e),lploggedin&&g_loggedinoffline&&(lpdbg("login","Trying to log in offline : notify user that they are logged in offline"),LPISLOC||lpshowError("LoggedInOffline",!1,!1,!1,null,!0))}function retryonlinelogin(e){if(console_log("server.js : retryonlinelogin delayms="+e),lploggedin&&g_loggedinoffline){var t=e/6e4;lpdbg("login","We're still logged in offline => retrying to login online.  retryinterval="+t+" minutes"),lplogincheck("retryonline");var a=2*e;a>12e5&&(a=12e5),setTimeout(function(){retryonlinelogin(a)},a)}}function lpTurnOffIcon(){lploggedin=!1,set_badge_text(""),drawIconAtRotation(0)}function lpLoginCheckResponse(e,t,a){console_log("server.js : lpLoginCheckResponse fromwebsite="+a);try{if(e&&4==e.readyState&&"function"==typeof t&&(200!=e.status||null==e.responseXML||null==e.responseXML.documentElement))return void t();if(4==e.readyState&&200==e.status&&null!=e.responseXML&&null!=e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok");if(o.length>0){var n=o[0].getAttribute("lpusername");if(g_username=lpusername=n,g_username_hash=SHA256(g_username),"retryonline"!=a&&1!=a)return void lpReadAllPrefs(function(){lpLoginCheckResponseStep2(e,n,a),drawIconAtRotation(0)})}}lpLoginResponse_win(e,a,!0)}catch(e){L("logincheckresponse: "+e)}}function lpLoginCheckResponseStep2(e,t,a){console_log("server.js : lpLoginCheckResponseStep2 fromwebsite="+a);try{var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok");1==o[0].getAttribute("trustexpired")&&clearuuid(t);var n=o[0].hasAttribute("trustuuid")?o[0].getAttribute("trustuuid"):"";n&&""!=n&&setuuid(n,g_username_hash),lpdbg("login","lpLoginCheckResponseStep2");var s=null!=o[0].getAttribute("sesamepassword")&&""!=o[0].getAttribute("sesamepassword"),i=null!=o[0].getAttribute("yubikeyhash")&&""!=o[0].getAttribute("yubikeyhash"),l=null!=o[0].getAttribute("googleauthenabled")&&"1"==o[0].getAttribute("googleauthenabled"),g=null!=o[0].getAttribute("gridenabled")&&""!=o[0].getAttribute("gridenabled"),u=null!=o[0].getAttribute("multifactorenabled")&&""!=o[0].getAttribute("multifactorenabled"),d=null!=o[0].getAttribute("sesameotpok")&&""!=o[0].getAttribute("sesameotpok"),c=null!=o[0].getAttribute("yubikeyotpok")&&""!=o[0].getAttribute("yubikeyotpok"),_=null!=o[0].getAttribute("googleauthotpok")&&""!=o[0].getAttribute("googleauthotpok"),p=null!=o[0].getAttribute("gridresponseok")&&""!=o[0].getAttribute("gridresponseok"),f=null!=o[0].getAttribute("multifactorresponseok")&&""!=o[0].getAttribute("multifactorresponseok"),m=null!=o[0].getAttribute("disableoffline")&&1==o[0].getAttribute("disableoffline");o[0].getAttribute("model")&&(g_lp_model=o[0].getAttribute("model")),o[0].getAttribute("do_totp")&&(g_do_totp="1"==o[0].getAttribute("do_totp")),console_log("server.js : ***** disableoffline="+m);if(!("websitelogin"==a||"webrootwebsitelogin"==a||"websiterefresh"==a||"websiterefreshrsa"==a||"2ndfactorok"==a||"frompipes"==a)&&(null==g_local_key||""==g_local_key)&&1==lpGetPref("logoffWhenCloseBrowser",0)){var h=lpGetPref("lastpollcheck",0),b=pref_numeric_validate(lpGetPref("logoffWhenCloseBrowserVal",0),0),v=1e3*lp_get_gmt_timestamp()-h;if(console_log("server.js : "+h+" "+b+" "+v),v>=6e4*b)return loggedOut(!1,"logoffWhenCloseBrowser lastpollcheck="+h+" logoffWhenCloseBrowserVal="+b+" timesincelastpollcheck="+v),void(1==lpGetPref("openloginstart",LPISUPEK?1:0)&&(g_reprompt_callback=null,g_reprompt_error_callback=null,open_login()))}if("httptest"==a){if(s){if(!d)return lpdbg("login","LoginCheck : Asking for sesame OTP and reissuing request to login_check.php"),lpdbg("sesame","LOGIN CHECK RESPONSE: sesameenabled => Asking user for OTP and then reissuing the login_check request"),sesame_setdata("fromwebsite",a),void lpCheckForKey(function(){sesame_getotp(t,o[0])});a="2ndfactorok",lpdbg("login","LoginCheck : sesame reprompt-rerequest succeeded!")}if(i){if(!c)return lpdbg("login","LoginCheck : Asking for yubikey OTP and reissuing request to login_check.php"),lpdbg("yubikey","LOGIN CHECK RESPONSE: yubikeyenabled => Asking user for OTP and then reissuing the login_check request"),yubikey_setdata("fromwebsite",a),void lpCheckForKey(function(){yubikey_getotp(t,o[0])});a="2ndfactorok",lpdbg("login","LoginCheck : yubikey reprompt-rerequest succeeded!")}if(l){if(!_)return lpdbg("login","LoginCheck : Asking for googleauth OTP and reissuing request to login_check.php"),lpdbg("googleauth","LOGIN CHECK RESPONSE: googleauthenabled => Asking user for OTP and then reissuing the login_check request"),googleauth_setdata("fromwebsite",a),void lpCheckForKey(function(){googleauth_getotp(t,o[0])});a="2ndfactorok",lpdbg("login","LoginCheck : googleauth reprompt-rerequest succeeded!")}if(g){if(!p)return lpdbg("login","LoginCheck : Asking for grid response and reissuing request to login_check.php"),lpdbg("grid","LOGIN CHECK RESPONSE: gridenabled => Asking user for coordinates and then reissuing the login_check request"),grid_setdata("fromwebsite",a),grid_setdata("wxsessid",o[0].getAttribute("wxsessid")),void grid_getvalues(t,o[0].getAttribute("challenge"),o[0]);a="2ndfactorok",lpdbg("login","LoginCheck : grid reprompt-rerequest succeeded!")}if(u){if(!f)return lpdbg("login","LoginCheck : Asking for multifactor response and reissuing request to login_check.php"),lpdbg("multifactor","LOGIN CHECK RESPONSE: multifactorenabled => Asking user for coordinates and then reissuing the login_check request"),multifactor_setdata("fromwebsite",a),multifactor_setdata("wxsessid",o[0].getAttribute("wxsessid")),multifactor_setdata("type",o[0].getAttribute("type")),void multifactor_getresponse(t,o[0].getAttribute("challenge"));a="2ndfactorok",lpdbg("login","LoginCheck : multifactor reprompt-rerequest succeeded!"),"omnikey"==multifactor_getdata("type")&&multifactor_setdata("password_offline",o[0].getAttribute("multifactorofflinepassword"))}}lpLoginResponse_win(e,a,!0)}catch(e){console_log(e.message)}}function lpLoginResponse2(e,t,a){console_log("server.js : lpLoginResponse fromwebsite="+a);try{if(console_log("server.js : Got login response"),e&&4==e.readyState&&"function"==typeof t&&(200!=e.status||null==e.responseXML||null==e.responseXML.documentElement))return void t();console_log("server.js : Processing login response"),lpLoginResponse_win(e,a,!1)}catch(e){L("loginresponse: "+e)}}function lpLoginResponse(e,t,a){lpLoginResponse2(e,t,a)}function lp_login_from_saved(){console_log("server.js : lp_login_from_saved");try{get_saved_logins(function(e){if(e.length>0){var t=e[0].username,a=e[0].password;if(""!=a){var r=function(e){LPISLOC&&LPISUPEK||""==e||(console_log("server.js : Logging in from saved"),LP_do_login(t,e,!0,!0))};return void(1==e[0].protected?unprotect_data(a,!1,r):2==e[0].protected&&r(lpdec(a,AES.hex2bin(SHA256(e[0].username)))))}}1==lpGetPref("openloginstart",LPISUPEK?1:0)&&(g_reprompt_callback=null,g_reprompt_error_callback=null,open_login())})}catch(e){console_log(e.message)}}function lpLoginCommon(e){console_log("server.js : lpLoginCommon bIsLoginCheck="+e),g_loggedinonline=!0,g_loggedinoffline=!1,g_notifytimerid&&(clearTimeout(g_notifytimerid),g_notifytimerid=null),g_retryonlinetimerid&&(clearTimeout(g_retryonlinetimerid),g_retryonlinetimerid=null)}function lpLoginError(){console_log("server.js : lpLoginError"),console_log("server.js : Got Login Error");var e=(new Date).getTime();e-lploginerrorhandlercalled<1e3||(lploginerrorhandlercalled=e,lpdbg("login","Login via login.php failed => try logging in offline using saved credentials -- if not already logged in offline --"),loginoffline(!1,"ErrorHandler"))}function lpLoginCheckError(){console_log("server.js : lpLoginCheckError"),lpdbg("login","Got lpLoginCheckError"),g_loggedinoffline||(lpshowError("ErrorLoginMsg"),loggedOut(!1,"lpLoginCheckError"),lp_login_from_saved())}function lpLoginResponse_win(e,t,a){if(console_log("server.js : lpLoginResponse_win fromwebsite="+t+" bIsLoginCheck="+a),e)if(4==e.readyState&&200==e.status&&null!=e.responseXML&&null!=e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok"),n=!1;if(lpdbg("login","lpLoginResponse_win"),o.length>0){lpdbg("login","got login ok");var s=o[0].hasAttribute("trustuuid")?o[0].getAttribute("trustuuid"):"";s&&""!=s&&setuuid(s,g_username_hash),server_tries=0,g_username=o[0].getAttribute("lpusername"),g_username_hash=SHA256(g_username);var i=!1;if(g_is_recovery_login)g_is_recovery_login=!1;else{if("1"==o[0].getAttribute("pwresetreqd")){var l=g_username;return a?openurlifnotopen(base_url+"passwordreset.php?u="+en(l)):openURL(base_url+"passwordreset.php?u="+en(l)),void loggedOut(!1,"pwresetreqd set")}if("0"!=o[0].getAttribute("pwresetreqd")&&""!=o[0].getAttribute("pwresetreqd")){var l=g_username,g="&req="+en(o[0].getAttribute("pwresetreqd"));a?openurlifnotopen(base_url+"passwordreset.php?u="+en(l)+g):openURL(base_url+"passwordreset.php?u="+en(l)+g),i=!0}}if(o[0].getAttribute("iterations")){var u=parseInt(o[0].getAttribute("iterations"));if(!checkIterationsReductionOk(u))return;localStorage_setItem(g_username_hash+"_key_iter",u)}g_iterpw="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",g_pwdeckey=AES.hex2bin(SHA256(o[0].getAttribute("pwdeckey"))),g_uid=lpuid=o[0].getAttribute("uid"),localStorage_setItem(g_username_hash+"LPMPD",g_uid),g_logoff_other_ses="1"==o[0].getAttribute("logoff_other_ses"),g_generatedpw="1"==o[0].getAttribute("generatedpw"),countryfromip=o[0].getAttribute("country"),g_lastpollcheck=g_lastpoll=lastlogin=(new Date).getTime(),g_token=lptoken=o[0].getAttribute("token");var d=o[0].getAttribute("noshare"),c=o[0].getAttribute("noshareexceptfolders");g_sharing_enabled="1"!=d&&"1"!=c,g_folder_sharing_enabled="1"!=d,g_one_minute_inbox_importer_dialog_enabled="1"===o[0].getAttribute("one_minute_inbox_importer_dialog"),g_one_minute_signup_enabled="1"===o[0].getAttribute("one_minute_signup"),g_one_minute_signup_menu_enabled="1"===o[0].getAttribute("one_minute_signup_menu"),g_onemin_advert_enabled="1"===o[0].getAttribute("one_minute_advert"),g_new_settings_enabled="1"===o[0].getAttribute("newsettings_enabled"),g_launch_site_tracking_enabled="1"===o[0].getAttribute("launch_site_tracking_enabled"),g_onemin_advert_enabled&&sendLpImprove("oneminute::notificationactivated");var _=o[0].getAttribute("onemin_advert_app_threshold");if(null!=_){var p=parseInt(_);isNaN(p)||(g_onemin_advert_app_threshold=p)}g_nofolder_feature_enabled="1"===o[0].getAttribute("nofolder_feature"),g_basicauth_feature_enabled="1"===o[0].getAttribute("basic_auth_enabled"),g_first_time_login="1"===o[0].getAttribute("first_time_login"),LPContentScriptFeatures.new_save_site="1"===o[0].getAttribute("new_save_site"),LPContentScriptFeatures.ziggy="1"===o[0].getAttribute("ziggy"),LPContentScriptFeatures.bunk2="1"===o[0].getAttribute("bunk2"),LPContentScriptFeatures.freamon="1"===o[0].getAttribute("freamon"),LPContentScriptFeatures.better_generate_password_enabled="1"===o[0].getAttribute("better_generate_password_enabled"),LPContentScriptFeatures.is_infield_enabled="1"===o[0].getAttribute("infield_enabled"),LPContentScriptFeatures.is_infield_autopopup_enabled="1"===o[0].getAttribute("infield_autopopup_enabled"),LPContentScriptFeatures.is_mobile_active="1"===o[0].getAttribute("mobile_active"),LPContentScriptFeatures.omaria="1"===o[0].getAttribute("omar_ia"),g_cid=o[0].getAttribute("cid");var f=o[0].getAttribute("tutorial_enabled");g_ischrome&&f&&"41"===f?LPContentScriptFeatures.tutorial_enabled="41":LPContentScriptFeatures.tutorial_enabled="40",localStorage_setItem(g_username_hash+".lpfeatures",JSON.stringify(LPContentScriptFeatures));var m=o[0].getAttribute("prefdata");if(m){m=atob(m);var h={};parsemobile(m,m.length,100,0,null,[],null,null,null,null,null,null,!0,!1,null,null,null,null,null,null,h,null,null,null,null,null,null,null,null,null,null,!1);for(var b in h)if(void 0===g_prefoverrides||g_prefoverrides[b]!==h[b]){g_prefoverrides=h,rewritelocalfile();break}}var v=o[0].getAttribute("pollinterval");v&&-1!=v&&!isNaN(parseInt(v))&&isFinite(v)&&(lpPutUserPref("pollServerVal",v),lpWriteAllPrefs(),g_flags.pollIntervalSetByPolicy=1),getsinglefactortype(function(e){"1"==o[0].getAttribute("multifactor_singlefactor")?(""==e&&("trueapi"==multifactor_getdata("type")?have_binary_function("trueapi_default_login_exists")&&call_binary_function("trueapi_default_login_exists",g_username,function(e){e&&setsinglefactortype(multifactor_getdata("type"))}):"vtapi"==o[0].getAttribute("singlefactortype")?have_binary_function("lpvt_has_data")&&call_binary_function("lpvt_has_data",function(e){e&&setsinglefactortype(o[0].getAttribute("singlefactortype"))}):"validity"==o[0].getAttribute("singlefactortype")?have_binary_function("validity_has_data")&&call_binary_function("validity_has_data",function(e){e&&setsinglefactortype(o[0].getAttribute("singlefactortype"))}):"winbio"==o[0].getAttribute("singlefactortype")?have_binary_function("winbio_has_data")&&call_binary_function("winbio_has_data",function(e){e&&setsinglefactortype(o[0].getAttribute("singlefactortype"))}):"nymi"==o[0].getAttribute("singlefactortype")&&have_binary_function("nymi_has_data")&&call_binary_function("nymi_has_data",function(e){e&&setsinglefactortype(o[0].getAttribute("singlefactortype"))})),"nymi"==o[0].getAttribute("singlefactortype")&&have_binary_function("nymi_get_version")&&call_binary_function("nymi_get_version",function(e){parseInt(o[0].getAttribute("nymi_version"))>e&&lpMakeRequest(base_url+"nymi_data.php","token="+en(o[0].getAttribute("token"))+"&action=read&b64=1",function(e){if(4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var t=e.responseXML.documentElement.getElementsByTagName("ok");t.length>0&&(call_binary_function("nymi_write_data",lpatob(t[0].getAttribute("data"))),setsinglefactortype("nymi"))}})})):""!=e&&disable_single_factor()}),sesame_setdata("password_offline",o[0].getAttribute("sesamepassword")),yubikey_setdata("password_offline",o[0].getAttribute("yubikeyhash"));var y=o[0].getAttribute("note_title");if(y&&y.length){var k=o[0].getAttribute("note_text"),w=o[0].hasAttribute("note_url")?o[0].getAttribute("note_url"):null;handlenotifications(y,k,w)}lpLoginResponse_win1_5(e,t,a),lpLoginCommon(a),lpdisableoffline=1==o[0].getAttribute("disableoffline")?1:0,lpdisableoffline&&(lpdbg("disableoffline","server.js : enabled => clearing sensitive files"),clearCache(!0,!1,!1,!0)),o[0].getAttribute("model")&&(g_lp_model=o[0].getAttribute("model")),o[0].getAttribute("do_totp")&&(g_do_totp="1"==o[0].getAttribute("do_totp")),!g_manual_login||i||1!=lpGetPref("showvault",g_showvaultdefault)&&!g_showvaultalways||(console_log("openvault from login okay"),"context"!==LPContentScriptFeatures.intro_tutorial_version&&openvault(1)),g_manual_login&&!i&&Topics.get(Topics.LOGIN_FINISHED).publish(),setTimeout(function(){checkAttach()},1e4)}else{console_log(e.responseText);var A=r.getElementsByTagName("error");if(A.length>0){if(lpdbg("login","got login error"),1==A[0].getAttribute("trustexpired")&&clearuuid(g_username),A[0].getAttribute("iterations")){var u=parseInt(A[0].getAttribute("iterations"));return void(checkIterationsReductionOk(u)&&(localStorage_setItem(SHA256(g_username)+"_key_iter",u)||(DEFAULT_KEY_ITERATIONS=u),LP_do_login(g_username,g_iterpw)))}if(A[0].getAttribute("pbkdf2fallback")&&("undefined"==typeof g_oldpbkdf2||1!=g_oldpbkdf2)){g_oldpbkdf2=1;yubikey_getdata("p");return void LP_do_login(g_username,g_iterpw)}if("undefined"!=typeof g_oldpbkdf2&&(g_oldpbkdf2=0),A[0].getAttribute("server")){var L=A[0].getAttribute("server");return void("lastpass.com"!=L&&"lastpass.eu"!=L||(base_url="https://"+L+"/",lpPutGblPref("server",L),LP_do_login(g_username,g_iterpw)))}if(A[0].getAttribute("openurl")){var x=A[0].getAttribute("openurl");openURL(x)}if(A[0].hasAttribute("invalidsession"))return openURL(base_url+"invalidsession.php"),lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0),clearCache(!0,!1,!1),void loggedOut(!1,"invalidsession");if(n=1==parseInt(A[0].getAttribute("silent")),allowmultifactortrust=!0,e.responseText.indexOf("allowmultifactortrust=")>0&&(allowtrust_str=e.responseXML.childNodes[0].childNodes[0].getAttribute("allowmultifactortrust"),allowmultifactortrust="false"!=allowtrust_str),hidemultifactordisable=!1,e.responseText.indexOf("hidedisable=")>0&&(hidedisable_str=e.responseXML.childNodes[0].childNodes[0].getAttribute("hidedisable"),hidemultifactordisable="false"!=hidedisable_str),e.responseText.indexOf("sesameotprequired")>0)return lpdbg("sesame","LOGIN RESPONSE: sesameenabled => Asking user for OTP and then reissuing the login request"),clearCache(!0,!1,!1),sesame_setdata("fromwebsite",t),void sesame_getotp(g_username,A[0]);if(e.responseText.indexOf("sesameotpfailed")>0)return lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0),clearCache(!0,!1,!1),void loggedOut(!1,"sesameotpfailed");if(e.responseText.indexOf("otprequired")>0)return lpdbg("yubikey","LOGIN RESPONSE: yubikeyenabled => Asking user for OTP and then reissuing the login request"),clearCache(!0,!1,!1),yubikey_setdata("fromwebsite",t),void yubikey_getotp(g_username,A[0]);if(e.responseText.indexOf("otpfailed")>0)return lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0),clearCache(!0,!1,!1),void loggedOut(!1,"otpfailed");var S=!1;if(e.responseText.indexOf("googleauthfailed")>0){var R=googleauth_getdata("fail_count");if(null==R&&(R=0),R++,googleauth_setdata("fail_count",R),!(R<5))return googleauth_setdata("fail_count",0),lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0),clearCache(!0,!1,!1),void loggedOut(!1,"otpfailed");S=!0}var C=!1;if(e.responseText.indexOf("securityquestionfailed")>0){var P=securityquestion_getdata("fail_count");if(null==P&&(P=0),P++,securityquestion_setdata("fail_count",P),!(P<5))return securityquestion_setdata("fail_count",0),lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0),clearCache(!0,!1,!1),void loggedOut(!1,"otpfailed");A.length>0&&A[0].getAttribute("message")&&alert(A[0].getAttribute("message")),C=!0}if(e.responseText.indexOf("googleauthrequired")>0||S)return lpdbg("googleauth","LOGIN RESPONSE: googleauthenabled => Asking user for OTP and then reissuing the login request"),clearCache(!0,!1,!1),googleauth_setdata("fromwebsite",t),void googleauth_getotp(g_username,A[0])
;if(e.responseText.indexOf("outofbandrequired")>0)return lpdbg("outofband","LOGIN RESPONSE: outofbandenabled => Asking user for OTP and then reissuing the login request"),clearCache(!0,!1,!1),outofband_setdata("fromwebsite",t),void outofband_getotp(g_username,A[0]);if(e.responseText.indexOf("securityquestionrequired")>0||C)return lpdbg("securityquestion","LOGIN RESPONSE: securityquestionenabled => Asking user for answer and then reissuing the login request"),clearCache(!0,!1,!1),securityquestion_setdata("fromwebsite",t),void securityquestion_getotp(g_username,A[0]);if(e.responseText.indexOf("gridresponserequired")>0)return lpdbg("grid","LOGIN RESPONSE: gridenabled => Asking user for grid response and then reissuing the login request"),clearCache(!0,!1,!1),grid_setdata("fromwebsite",t),grid_setdata("wxsessid",A[0].getAttribute("wxsessid")),void grid_getvalues(g_username,A[0].getAttribute("challenge"),A[0]);if(e.responseText.indexOf("gridresponsefailed")>0)return lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0),clearCache(!0,!1,!1),void loggedOut(!1,"gridresponsefailed");if(e.responseText.indexOf("multifactorresponserequired")>0)return lpdbg("multifactor","LOGIN RESPONSE: multifactorenabled => Asking user for multifactor response and then reissuing the login request"),clearCache(!0,!1,!1),multifactor_setdata("fromwebsite",t),multifactor_setdata("wxsessid",A[0].getAttribute("wxsessid")),multifactor_setdata("type",A[0].getAttribute("type")),void multifactor_getresponse(g_username,A[0].getAttribute("challenge"));if(e.responseText.indexOf("multifactorresponsefailed")>0){var A=r.getElementsByTagName("error"),E=A&&A.length>0&&A[0].getAttribute("type")?A[0].getAttribute("type"):multifactor_getdata("type");return lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0,!1,get_multifactor_disable_url(g_username,E)),clearCache(!0,!1,!1),void loggedOut(!1,"multifactorresponsefailed")}}if(g_trial_available=1==A[0].getAttribute("trialavailable"),1==A[0].getAttribute("trialavailable")?lpTurnOffIcon():loggedOut(n,"lpLoginResponse_win A"),n)lp_login_from_saved();else if(e.responseText.indexOf("blacklist")>0)clearCache(!0,!1,!1),lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"Blacklist",!1,!0,!1,null,!1,A[0].getAttribute("custombutton"),A[0].getAttribute("customaction"));else{var I=A.length>0&&A[0].getAttribute("cause")&&"unknownemail"==A[0].getAttribute("cause");try_alternativeServer()?LP_do_login(g_retryusername,g_iterpw):lpshowError(A.length>0&&A[0].getAttribute("message")?A[0].getAttribute("message"):"LoginError",!1,!0,I,null,!1,A[0].getAttribute("custombutton"),A[0].getAttribute("customaction"),1==A[0].getAttribute("trialavailable"))}}}else loggedOut(!1,"lpLoginResponse_win B"),lpshowError("ErrorLoginMsg")}function try_alternativeServer(){return("undefined"==typeof g_disable_alternative_server||!g_disable_alternative_server)&&("https://lastpass.com/"!=original_base&&"https://lastpass.eu/"!=original_base&&(server_tries++,3==server_tries||"https://lastpass.com/"==base_url||"https://lastpass.eu/"==base_url?base_url=original_base:base_url="https://lastpass.com/",lpPutGblPref("server",base_url.substr(8,base_url.length-1)),3!=server_tries||(server_tries=0,!1)))}function disable_single_factor(){getsinglefactortype(function(e){"trueapi"==e&&have_binary_function("trueapi_delete_default_login")&&call_binary_function("trueapi_delete_default_login"),setsinglefactortype("")})}function lpLoginResponse_win1_5(e,t,a){console_log("server.js : lpLoginResponse_win1_5 fromwebsite="+t+" bIsLoginCheck="+a);var r=e.responseXML.documentElement;r.getElementsByTagName("ok");if(null==g_local_key||""==g_local_key){if(!("websitelogin"==t||"webrootwebsitelogin"==t||"websiterefresh"==t||"websiterefreshrsa"==t||"2ndfactorok"==t||"frompipes"==t)&&1==lpGetPref("logoffWhenCloseBrowser",0))return void lpReadAllPrefs(function(){lpLoginResponse_win1_75(e,t,a),drawIconAtRotation(0)});lpReadKeyFile(e,t,!1,a)}else lpWriteKeyFile(),lpReadAllPrefs(function(){lpLoginResponse_win2(e,t,a),drawIconAtRotation(0)})}function lpLoginResponse_win1_75(e,t,a){console_log("server.js : lpLoginResponse_win1_75 fromwebsite="+t+" bIsLoginCheck="+a);var r=lpGetPref("lastpollcheck",0),o=pref_numeric_validate(lpGetPref("logoffWhenCloseBrowserVal",0),0),n=1e3*lp_get_gmt_timestamp()-r;if(n>=6e4*o)return void loggedOut(!1,"lpLoginResponse_win1_75 lastpollcheck="+r+" logoffWhenCloseBrowserVal="+o+" timesincelastpollcheck="+n);lpReadKeyFile(e,t,!1,a)}function lpLoginResponse_win2(e,t,a){console_log("server.js : lpLoginResponse_win2 fromwebsite="+t+" bIsLoginCheck="+a);var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok");closeallnotifications(!0,!0),lp_phpsessid=o[0].getAttribute("sessionid"),loggedIn(),g_server_accts_version=parseInt(o[0].getAttribute("accts_version")),lp_server_attach_version=parseInt(o[0].getAttribute("attachversion")),console_log("server.js : lpLoginResponse_win2 lp_server_attach_version="+lp_server_attach_version),g_server_accts_version!=g_local_accts_version&&(g_local_accts_version=-1),g_loglogins=parseInt(o[0].getAttribute("loglogins")),g_isadmin=1==parseInt(o[0].getAttribute("isadmin")),g_iscompanyadmin=1==parseInt(o[0].getAttribute("companyadmin")),g_showcredmon=1==parseInt(o[0].getAttribute("showcredmon")),iconsversion=parseInt(o[0].getAttribute("iconsversion")),g_multifactorscore=parseInt(o[0].getAttribute("multifactorscore")),g_disablepwalerts=1==parseInt(o[0].getAttribute("disablepwalerts")),lpsendchallengescore=null!=o[0].getAttribute("sendchallengescore")&&1==o[0].getAttribute("sendchallengescore"),pwndlistscan=null!=o[0].getAttribute("pwndlistscan")&&1==o[0].getAttribute("pwndlistscan"),loglogin_url=null!=o[0].getAttribute("logloginsvr")?"https://"+o[0].getAttribute("logloginsvr")+"/":base_url,pollserver_url=null!=o[0].getAttribute("pollserver")?"https://"+o[0].getAttribute("pollserver")+"/":base_url;var n=o[0].getAttribute("pushserver");null!=n&&n.length&&setup_push_listener(n),lpCheckDownloadNewDataFile(o[0].getAttribute("formfillver"),"ff.dat",ffver,"ff","ff.dat"),lpCheckDownloadNewDataFile(o[0].getAttribute("sitesver"),"sites.dat",-1,"sites","sites.dat"),lpCheckDownloadNewDataFile(o[0].getAttribute("bigicon"),"bigicons.dat",-1,"bigicon","bigicons.dat"),""==o[0].getAttribute("privatekeyenchash")?(console_log("RSA : login response : server returned blank privatekeyenchash : calling generateSharingKeys()"),generateSharingKeys()):(console_log("RSA : login response : server returned privatekeyenchash : calling readrsaprivatekeyhexfromdb() to make sure it matches the local value"),readrsaprivatekeyhexfromdb(!1,!0,o[0].getAttribute("privatekeyenchash"))),(!a||"boolean"==typeof t&&t)&&lpnp_send_internal_logincheck_ack();var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok");if(1==lpGetPref("storeLostOTP",1)&&o[0].hasAttribute("lostpwotpresult")&&"ok"!=o[0].getAttribute("lostpwotpresult")&&0==g_norecovery&&(DeleteOTP(),MakeOTP()),hassites()&&g_server_accts_version==g_local_accts_version||(console_log("server.js : !hassites() or server_ver:"+g_server_accts_version+" != local_ver:"+g_local_accts_version+" so calling get_accts_local!"),get_accts_local()),checkIconsVersion(iconsversion),checkBigIconsVersion(null,!1,!0),checkBigIconsVersion(null,!1,!0,"sq"),lpretryrequests(),o[0].getAttribute("sauid0")){for(var s=0,i="";o[0].getAttribute("sauid"+s);){var l=lprsa_encryptdata(o[0].getAttribute("sakey"+s),AES.bin2hex(g_local_key));l&&(i+="&sauid"+s+"="+en(o[0].getAttribute("sauid"+s))+"&sakey"+s+"="+en(l)),s++}i.length&&lpMakeRequest(base_url+"uploadsuperkeys.php","cmd=uploadsuperadmin&"+i,null,null)}}function lpCheckDownloadNewDataFile(e,t,a,r,o){if(""!=e&&0!=e){var n=a,s=localStorage_getItem(o),i=!1;if(null!=s&&""!=s&&"\n"!=s){var l=-1==s.indexOf("\n")?s.length:s.indexOf("\n");n=s.substr(0,l)}else i=!0;if(null!=n&&""!=n&&-1!=n&&CompareLastPassVersions(e,n)>0&&(i=!0),i){var g=base_url+"getappdata.php";lpMakeRequest(g,"type="+en(r),lpDownloadDataResponse,null,o)}}}function get_accts(){var e=(new Date).getTime();if(!(e-lplastgetaccounts<1e3)){lplastgetaccounts=e;var t=base_url+"getaccts.php?mobile=1&b64=1&shap=1&u="+g_username_hash;t+="&includesharedfolderformfillprofiles=1",t+="&includeemergencyaccess=1",t+="&includependingsharedfolders=1",""!=adminoverride&&(t+="&adminoverride="+en(adminoverride)),lpMakeRequest(t,"",lpAcctsResponse,lpAcctsError)}}function get_accts_local(e,t){lpReadAcctsData(e,t)}function lpAcctsResponse(e){if(e&&4==e.readyState){var t=atob(e.responseText);write_history({cmd:"get_accts_success",sz:t.length,ready_state:e.readyState,status:e.status,lver:g_local_accts_version,sver:g_server_accts_version});var a=[],r=[],o={},n=[],s=[],i={},l=[],g=[],u=[],d=[],c=[],_=[],p={},f=[],m=[],h=[],b=[],v=[];lp_premium_exp=0,lp_enterpriseuser=0;var y=get_ff_translation("ff_captcha_regexp");lp_captcha_regexp=""!=y?new RegExp(y,"i"):null,g_emer_sharers=[],g_emer_sharees=[],g_totp={},g_note_templates=[],g_reminders=[],parsemobile(t,t.length,100,0,postacctsload,a,r,o,n,s,i,l,!0,!1,null,g,u,d,c,_,p,lp_rsaprivatekeyhex,f,null,null,null,m,h,b,v,void 0,void 0,g_emer_sharers,g_emer_sharees,g_totp,g_note_templates,g_pending_shares,g_reminders),g_premium_exp=lp_premium_exp,g_enterpriseuser=lp_enterpriseuser}else write_history({cmd:"get_accts_fail",sz:e&&"string"==typeof e.responseXML?e.responseXML.length:-1,ready_state:e?e.readyState:-1,status:e?e.status:-1,lver:g_local_accts_version,sver:-1})}function get_ff_translation(e){var t=lpGetPref("language","");""==t&&(t=navigator.language);var a=t;if(t=t.replace("-","_"),"es_419"!=t&&"es_419"!=a&&"es-419"!=a&&"es_xl"!=t&&"es_xl"!=a&&"es-xl"!=a||(t="es_MX",a="es-MX"),void 0===translations[t]&&void 0===translations[a]&&(t=t.substring(0,2),a=t),void 0===translations[t]&&void 0===translations[a])for(var r in translations)if(r.substring(0,2)==t){t=r,a=t;break}if(void 0===translations[t]&&void 0===translations[a]&&(t="en_US",a="en-US"),void 0===translations[t]&&void 0===translations[a]){t="en",a="en";for(var r in translations)if(r.substring(0,2)==t){t=r,a=t;break}}return void 0!==translations[t]&&void 0!==translations[t][e]&&""!=translations[t][e]?translations[t][e]:void 0!==translations[a]&&void 0!==translations[a][e]&&""!=translations[a][e]?translations[a][e]:void 0!==translations.en_US&&void 0!==translations.en_US[e]&&""!=translations.en_US[e]?translations.en_US[e]:void 0!==translations["en-US"]&&void 0!==translations["en-US"][e]&&""!=translations["en-US"][e]?translations["en-US"][e]:""}function rewritelocalfile(e,t,a){a=void 0===a?null:a;var r=flattendata(g_local_accts_version,g_sites,g_securenotes,g_prompts,g_formfills,g_identities,g_equivalentdomains,g_neverurls,g_premium_exp,lpenc(g_username),g_pendings,g_shareeautopushes,lpmaxid,g_urlrules,g_prefoverrides,g_shares,g_applications,g_enterpriseuser,lp_attaches,g_emer_sharers,g_emer_sharees,g_totp,g_note_templates,g_pending_shares);if(r=btoa(r),(LPISLOC||a)&&(r="LPB64"+r),r=prependOTPAndEncrypt(r),r=prependIterations(r),lpSaveData(r,"accts"),LPISLOC||a){if(r=lpenc(r),r=prependIterations(r),a||lpdisableoffline)return r;protect_data(r,!0,null,function(r){if(have_binary_function("write_file")){var o="";e&&(o="_"+(new Date).toString().replace(" ","_"));var n=db_prepend(g_username_hash+o+"_lps.act.sxml");a&&(n="lpexport.xml"),call_binary_function("write_file",n,r)}e||t||lpnp_notify("refresh_local",{data0:g_username_hash})})}update_menus(!0)}function prependOTPAndEncrypt(e){var t=null,a="";if(sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")?(lpdbg("sesame","encrypting accounts file before writing"),t=sesame_getdata("password_offline"),a="type=sesameoffline\ndata="):multifactor_getdata("password_offline")&&""!=multifactor_getdata("password_offline")?(lpdbg("multifactor","encrypting accounts file before writing"),t=multifactor_getdata("password_offline"),a="type="+multifactor_getdata("type")+"offline\ndata="):yubikey_getdata("password_offline")&&""!=yubikey_getdata("password_offline")&&(lpdbg("yubikey","encrypting accounts file before writing"),t=yubikey_getdata("password_offline"),a="type=yubikeyoffline\ndata="),t){if(!(e=enc(e,hex2bin(t)))||""==e)return lpdbg("error","Failed to encrypt data in save_accounts_fileraw"),!1;e=a+e}return e}function clearSavedPassword(e){var t=opendb();createSavedLoginsTable(t),t&&(console_log("server.js : clearing saved credentials"),g_indexeddb?t.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(e)).onsuccess=function(e){e.target.result&&""!=e.target.result.value.password&&(e.target.result.value.password="",t.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(e.target.result.value))}:t.transaction(function(t){t.executeSql("UPDATE LastPassSavedLogins2 SET password = '' WHERE username = ?",[e])}))}function checkforknownhackedsites(){return}function postacctsload(e,t,a,r,o,n,s,i,l,g,u,d,c,_,p,f,m,h,b,v,y,k){if(lploggedin){if(!i&&(!g||g&&0==e.length))return console_log("server.js : ERROR: Could not parse accts data!!!"),void(gPulledInvalidAccts?lpshowError("ErrorGetAcctsMsg"):(gPulledInvalidAccts=!0,get_accts()));try{if(null!=lp_trueapi_trial_exp){var w=parseInt(lp_trueapi_trial_exp);w>0&&w<parseInt((new Date).getTime()/1e3)&&(getsinglefactortype(function(e){"trueapi"==e&&setsinglefactortype("")}),"trueapi"==multifactor_getdata("type")&&multifactor_setdata("type",""))}}catch(e){}if(e.length>0&&void 0!==u&&null!=u&&""==adminoverride){var A=lpdec(u);if(""!=u&&null!=u&&"null"!=u&&g_username!=A)return lpReportError("Encrypted username check failed: "+g_username+" vs "+A+" for "+u+" local "+g,null),lpshowError("A consistency check failed while loading your sites. Please relogin."),clearSavedPassword(g_username),clearAllData(),loggedOut(!1,"encryptedusername_check_failed"),!1}if(lpmaxid=_.maxid,!g){var L=btoa(l);L=prependOTPAndEncrypt(L),L=prependIterations(L),lpSaveData(L,"accts")}var x={};g_tlds={};for(var S=AES.bin2hex(g_local_key),R=0;R<e.length;R++){if(e[R].url=AES.hex2url(e[R].url),e[R].tld=lp_gettld_url(e[R].url),LPISLOC&&e[R].tld)try{var C=function(){rfdefaults&&void 0!==rfdefaults[e[R].tld]&&(e[R].submit_id=rfdefaults[e[R].tld].submit_id,e[R].captcha_id=rfdefaults[e[R].tld].captcha_id,e[R].custom_js=rfdefaults[e[R].tld].custom_js)};rfdefaults?C():lpReadFile("rfdefaults",function(e){rfdefaults=JSON.parse(lp_hex2bin(e)),C()})}catch(e){}var P=void 0===e[R].sharefolderid?g_local_key:getsharekey(h,e[R].sharefolderid);if(null!=P){var E=void 0===e[R].sharefolderid?S:AES.bin2hex(P);e[R].unencryptedUsername=lpmdec(e[R].username,!0,P,E)}void 0===g_tlds[e[R].tld]&&(g_tlds[e[R].tld]={}),g_tlds[e[R].tld][e[R].aid]=!0,x[e[R].aid]=e[R]}for(var I={},R=0;R<t.length;R++)t[R].url=AES.hex2url(t[R].url),I[t[R].aid]=t[R];for(var O={},R=0;R<b.length;R++)b[R].appname=AES.hex2url(b[R].appname),O[b[R].appaid]=b[R];g_sites=x,g_securenotes=I,g_applications=O,g_prompts=a,g_formfills=r,g_identities=o,g_equivalentdomains=n,g_urlrules=p,g_neverurls=s,g_pendings=d,g_prefoverrides=m,g_shares=h,lp_attaches=v,g_shares.length>0&&("undefined"==typeof lp_rsaprivatekeyhex||null==lp_rsaprivatekeyhex||""==lp_rsaprivatekeyhex)&&"undefined"==typeof g_keyloopprotection&&setTimeout(function(){lp_rsaprivatekeyhex&&""!=lp_rsaprivatekeyhex?(g_keyloopprotection=!0,get_accts_local()):(g_keyloopprotection=!0,console_log("RSA : post accounts load : calling readrsaprivatekeyhexfromdb()"),readrsaprivatekeyhexfromdb(!0,!0,null,function(){lp_rsaprivatekeyhex&&""!=lp_rsaprivatekeyhex&&get_accts()}))},5e3),overrideprefs(g_prefoverrides),setcachedffdat(),g_shareeautopushes=new Array,parseAutoPushMobile(c,g_shareeautopushes);for(var R=0;R<g_formfills.length;R++)g_formfills[R].decprofilename=lpmdec_acct(g_formfills[R].profilename,!0,g_formfills[R],g_shares);g_formfills.sort(function(e,t){return e.decprofilename.toLowerCase()<t.decprofilename.toLowerCase()?-1:1}),"undefined"!=typeof g_identity&&null!=g_identity||(g_identity="");for(var T=!1,R=0;R<g_identities.length;R++)g_identities[R].deciname=lpdec(g_identities[R].iname),g_identities[R].iid==g_identity&&(T=!0);if(g_identities.sort(function(e,t){return e.deciname.toLowerCase()<t.deciname.toLowerCase()?-1:1}),!T&&""!=g_identity)return identityFilter="",switch_identity("",!0),clearCache(!0,!1,!1),setTimeout(function(){loggedOut(!1,"wrongidentity")},500),console_log("Identity: "+g_identity),alertfrombg(gs("Your selected Identity no longer exists. Defaulting to 'All' and logging off.")),!1;rsa_acceptpendingshares(),rsa_acceptshareeautopushes();var C=function(e){e=null==e?"":e;for(var t=e.split("\n"),a=0;a<t.length;a++){var r=t[a].split(" ");if(2==r.length&&""!=r[0]&&""!=r[1]){var o=r[0],n=r[1];g_sites[o]&&n>g_sites[o].last_touch&&(g_sites[o].last_touch=n)}}},q="";if((g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lt.cac"),C):("undefined"!=typeof localStorage&&(q=localStorage_getItem(db_prepend(g_username_hash+"_lt.cac"))),C(q)),"undefined"!=typeof foundmsfi&&0==g){postdata="";var D=0;for(var R in msfids){for(var M=msfids[R].shareid,U="",F=null,j=0;j<g_shares.length;j++)if(g_shares[j].id==M){U=AES.bin2hex(g_shares[j].key),F=g_shares[j].decsharename;break}if(null!==F){var N=new RSAKey;if(parse_public_key(N,msfids[R].key)){var K=N.encrypt(U),B=lpenc(F,g_shares[j].key);postdata+="&sharekey"+D+"="+encodeURIComponent(K)+"&uid"+D+"="+encodeURIComponent(msfids[R].uid),postdata+="&shareid"+D+"="+encodeURIComponent(msfids[R].shareid),postdata+="&decsharename"+D+"="+encodeURIComponent(F),postdata+="&encsharename"+D+"="+encodeURIComponent(B),D++}}}D=0,lpMakeRequest(base_url+"process_msf.php",postdata,null,null)}if(console_log("server.js : num sites: "+e.length+" num sn: "+t.length+" num ff: "+g_formfills.length+" num identities: "+g_identities.length+" pendings: "+g_pendings.length+" num applications: "+g_applications.length),recheckall(),update_menus(!0),void 0!==y&&y.attachversion>lp_server_attach_version&&(console.log("setting lp_server_attach_version="+y.attachversion),lp_server_attach_version=y.attachversion),g_runchallenge?setTimeout(function(){runChallenge()},1e4):fix_sites_secure_reprompt(),void 0!==k&&"function"==typeof handle_pending_pushed_sites&&handle_pending_pushed_sites(k,function(){get_accts()},g_shares),checkBigIconsVersion(),checkBigIconsVersion(null,null,null,"sq"),checkforknownhackedsites(),"undefined"!=typeof share_folder_group&&""!=share_folder_group&&"undefined"!=typeof share_folder_id&&""!=share_folder_id)for(var R=0;R<h.length;R++)if(h[R].id==share_folder_id){var G=share_folder_group;set_share_folder_group(""),set_share_folder_id(""),renameGroup(G,h[R].decsharename);break}}}function setcachedffdat(){var e=localStorage_getItem("ff.dat");e=null==e?translations:LPJSON.parse(e);for(var t=[],a=0;a<g_formfills.length;a++)t[lpmdec_acct(g_formfills[a].profilelanguage,!0,g_formfills[a],g_shares)]=1;var r=[];for(var a in e)"en-US"!=a&&void 0===t[a]||(r[a]=e[a]);g_cachedffdat=LPJSON.stringify(r)}function overrideprefs(e){void 0!==e.allowmasterpasswordsave&&"0"==e.allowmasterpasswordsave?(lpPutGblPref("rememberpassword",0),g_master_password_saved=!1,deletesavedpw(),localStorage_setItem(g_username_hash+".noremember",1)):localStorage_removeItem(g_username_hash+".noremember"),void 0!==e.logoffclosebrowser&&"-1"!=e.logoffclosebrowser&&(lpPutGblPref("logoffWhenCloseBrowser",1),lpPutGblPref("logoffWhenCloseBrowserVal",e.logoffclosebrowser)),void 0!==e.logoffidle&&"-1"!=e.logoffidle&&(lpdbg("idle","overriding idleLogoffVal with value from server: "+e.logoffidle),lpPutUserPref("idleLogoffVal",e.logoffidle)),void 0!==e.noexport&&"-1"!=e.noexport&&lpPutUserPref("noexport",e.noexport),lpWriteAllPrefs(),"string"==typeof e.sitepwlen&&""!=e.sitepwlen?LP.sitepwlen=JSON.parse(e.sitepwlen):LP.sitepwlen=new Array,void 0!==e.hideidentities&&"-1"!=e.hideidentities&&(g_hideidentities="1"==e.hideidentities),"string"==typeof e.savesitestopersonal&&""!=e.savesitestopersonal?g_savesitestopersonal=e.savesitestopersonal.split(","):g_savesitestopersonal=new Array}function lpAcctsError(){L("Error xhr_accts")}function loglogin(e,t,a){get_selected_tab(null,function(r){logloginurl(e,r,t,a)})}function tab_is_private(e){return g_isfirefoxsdk?g_private_browsing.isPrivate(e):void 0!==e.incognito&&e.incognito}function loglogintab(e,t,a,r){tab_is_private(t)||logloginurl(e,gettaburl(t),a,r)}function logloginurl(e,t,a,r){var o=lp_get_gmt_timestamp();if(void 0!==g_sites[e]){if(parseFloat(o)<5+parseFloat(g_sites[e].last_touch))return;g_sites[e].last_touch=o,writenewts(e,o)}else if(void 0!==g_securenotes[e]){if(o==g_securenotes[e].last_touch)return;if(g_securenotes[e].last_touch=lp_get_gmt_timestamp(),rewritelocalfile(),!g_loglogins||4!=(4&g_loglogins))return}if(g_loglogins){var n=getacct(e);if(n){var s=issharedfolder(g_shares,n.group);if(s&&s.id===get_personal_linked())return;var i=(new PostParams).add("id",e).add("method",get_method());a&&i.add("source",a),void 0!==r&&i.add("autologin",r),g_loglogins>1&&n&&(2==(2&g_loglogins)&&"http://sn"!=n.url&&i.add("u",AES.url2hex(t)),4==(4&g_loglogins)&&i.add("n",AES.url2hex(n.name)),8==(8&g_loglogins)&&i.add("un",AES.url2hex(getusernamefromacct(n)))),s&&i.add("sharedfolderid",s.id),lpMakeRequest(loglogin_url+"loglogin.php",i.toString(),null,null)}}}function logmpwreuse(e){if(requirechangereuse()||g_loglogins){var t="plog=1&u="+encodeURIComponent(e);lpMakeRequest(loglogin_url+"loglogin.php",t,null,null)}}function writenewts(e,t){var a=function(a){a=null==a?"":a;for(var r=a.split("\n"),o="",n=0;n<r.length;n++)0!=r[n].indexOf(e+" ")&&""!=r[n]&&(o+=r[n]+"\n");o+=e+" "+t+"\n",(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("write_file")&&call_binary_function("write_file",db_prepend(g_username_hash+"_lt.cac"),o),"undefined"!=typeof localStorage&&localStorage_setItem(db_prepend(g_username_hash+"_lt.cac"),o)},r="";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lt.cac"),a):("undefined"!=typeof localStorage&&(r=localStorage_getItem(db_prepend(g_username_hash+"_lt.cac"))),a(r))}function logformfill(e,t,a,r){get_selected_tab(null,function(o){if(!tab_is_private(o)&&g_loglogins){for(var n=(new PostParams).add("ffid",e).add("method",get_method()),s=0;s<g_formfills.length;s++)if(g_formfills[s].ffid==e){var i=issharedfolder(g_shares,void 0!==g_formfills[s].group?g_formfills[s].group:"");i&&n.add("sharedfolderid",i.id);break}t&&n.add("u",bin2hex(t)),a&&n.add("source",a),r||(r="en-US"),n.add("lang",r);var l=get_lplanguage();l=""===l?"en-US":l.replace("_","-"),n.add("difflang",l===r?0:1),lpMakeRequest(base_url+"logformfill.php?"+n.toString(),"",null,null)}})}function logclearform(e,t){get_selected_tab(null,function(a){if(!tab_is_private(a)&&g_loglogins){var r=(new PostParams).add("ffclear",1).add("method",get_method());t&&r.add("source",t),e&&r.add("u",bin2hex(e)),lpMakeRequest(base_url+"logformfill.php?"+r.toString(),"",null,null)}})}function lpCreateKeyFileData(){if("undefined"!=typeof g_pwdeckey&&null!=g_pwdeckey&&"undefined"!=typeof g_local_key&&null!=g_local_key){var e=AES.bin2hex(g_local_key);return AES.Encrypt({pass:g_pwdeckey,data:e,b64:!0,mode:"ecb",bits:256})+"\n"+AES.Encrypt({pass:g_local_key,data:"lastpass rocks",b64:!0,mode:"ecb",bits:256})}return""}function lpWriteKeyFile(){console_log("server.js : lpWriteKeyFile : start");var e=lpCreateKeyFileData();""!=e?(console_log("server.js : lpWriteKeyFile : calling lpSaveData"),lpSaveData(e,"key"),(g_is_win||g_is_mac||g_is_linux)&&have_binary_function("write_file")?(console_log("server.js : lpWriteKeyFile : calling protect_data"),protect_data(e,!0,null,function(e){console_log("server.js : lpWriteKeyFile : protect_data callback"),console_log("server.js : lpWriteKeyFile : calling binary function to write keyfile"),call_binary_function("write_file",db_prepend(g_username_hash+"_lpall.slps"),e)})):console_log("server.js : lpWriteKeyFile : did not have binary function, so not writing")):console_log("server.js : lpWriteKeyFile : not writing A")}function lpReadKeyFile(e,t,a,r){console_log("server.js : lpReadKeyFile fromwebsite="+t+" silent="+a+" bIsLoginCheck="+r);var o=opendb();if(createDataTable(o),o){console_log("server.js : lpReadKeyFile : reading db"),console_log("server.js : lpReadKeyFile : starting db transaction");var n=function(a,o){if(console_log("server.js : lpReadKeyFile : reading numrows="+o.rows.length),o.rows.length>0){var n=o.rows.item(0).data;if(n){var s=n.split("\n");if(2==s.length){var i=null;i=e?AES.hex2bin(lpdec(s[0],g_pwdeckey)):g_local_key;if("lastpass rocks"==lpdec(s[1],i)){if(g_local_key=i,g_local_key_hex=AES.bin2hex(i),g_local_key_hash=SHA256(g_local_key),e)return console_log("server.js : lpReadKeyFile : worked -- calling lpLoginResponse_win2"),void lpLoginResponse_win2(e,t,r);loggedIn(),console_log("server.js : lpReadKeyFile worked -- calling get_accts_local"),get_accts_local(!0)}else console_log("server.js : lpReadKeyFile : data was corrupt A")}else console_log("server.js : lpReadKeyFile : data was corrupt B")}else console_log("server.js : lpReadKeyFile : did not find any data")}else console_log("server.js : lpReadKeyFile : failed to read -- calling lp_login_from_saved"),lp_login_from_saved();e&&loggedOut(!1,"keyfailed")},s=function(e,t){console_log("server.js : lpReadKeyFile failed error="+t)};if(LPISLOC)console_log("server.js : lpReadKeyFile calling read_key_from_file"),read_key_from_file(function(e){console_log("server.js : lpReadKeyFile read_key_from_file callback"),""!=e?n(tx,{rows:{length:1,item:function(t){return{data:e}}}}):n(tx,{rows:{length:0}})});else if(console_log("server.js : lpReadKeyFile calling executeSql"),g_indexeddb){var i={rows:{item:function(e){return this[e]},length:0}};o.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_key")).onsuccess=function(e){var t=e.target.result;t?(i.rows[i.rows.length]=t.value,i.rows.length++,t.continue()):n(0,i)}}else o.transaction(function(e){e.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND type=?",[db_prepend(g_username_hash),"key"],n,s)})}else console_log("server.js : lpReadKeyFile : failed to open database")}function lpCheckForKey(e){var t=opendb();if(createDataTable(t),t){var a=function(t,a){a.rows.length>0?e():console_log("no key")},r=function(e,t){console_log(t)};if(LPISLOC)read_key_from_file(function(e){""!=e?a(tx,{rows:{length:1,item:function(t){return{data:e}}}}):a(tx,{rows:{length:0}})});else if(g_indexeddb){var o={rows:{item:function(e){return this[e]},length:0}};t.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_key")).onsuccess=function(e){var t=e.target.result;t?(o.rows[o.rows.length]=t.value,o.rows.length++,t.continue()):a(0,o)}}else t.transaction(function(e){e.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND type=?",[db_prepend(g_username_hash),"key"],a,r)})}}function lpReadAcctsData(e,t,a,r){function o(e){"string"==typeof e&&(s=e),write_history({cmd:"get_accts_local",status_s:s,sz:n,lver:g_local_accts_version,sver:g_server_accts_version})}if(null==g_username||""==g_username)return void o("error");var n=-1,s="ok",i=opendb();if(createDataTable(i),i){var l=function(s,i){if(i.rows.length>0){if(data=i.rows.item(0).data,data&&""!=data){if(data=checkIterationsInDataFile(data),"iterationserror"==data)return console_log("server.js : local accts data corrupt - key mismatch. redownloading"),o("error"),void get_accts();if(e&&(!sesame_getdata("password_offline")||""==sesame_getdata("password_offline")||!yubikey_getdata("password_offline")||""==yubikey_getdata("password_offline")||!multifactor_getdata("password_offline")||""==multifactor_getdata("password_offline"))){if(0==data.substring(0,30).indexOf("type=sesameoffline\ndata="))return sesame_setdata("offline","1"),void sesame_getotp(g_username);if(0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")||0==data.substring(0,30).indexOf("type=omnikeyoffline\ndata="))return multifactor_setdata("offline","1"),multifactor_setdata("type",0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")?"trueapi":"omnikey"),void multifactor_getresponse(g_username);if(0==data.substring(0,30).indexOf("type=yubikeyoffline\ndata="))return yubikey_setdata("offline","1"),void yubikey_getotp(g_username)}var l=null;sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")&&0==data.substring(0,30).indexOf("type=sesameoffline\ndata=")?(lpdbg("sesame","decrypting accounts file after reading"),data=data.substring(24),l=sesame_getdata("password_offline")):!multifactor_getdata("password_offline")||""==multifactor_getdata("password_offline")||0!=data.substring(0,30).indexOf("type=trueapioffline\ndata=")&&0!=data.substring(0,30).indexOf("type=omnikeyoffline\ndata=")?yubikey_getdata("password_offline")&&""!=yubikey_getdata("password_offline")&&0==data.substring(0,30).indexOf("type=yubikeyoffline\ndata=")&&(lpdbg("yubikey","decrypting accounts file after reading"),data=data.substring(25),l=yubikey_getdata("password_offline")):(lpdbg("multifactor","decrypting accounts file after reading"),data=data.substring(25),l=multifactor_getdata("password_offline")),l&&(data=dec(data,hex2bin(l)))}LPISLOC&&data.length>=5&&"LPB64"==data.substring(0,5)&&(data=data.substring(5));try{data=atob(data),n=data.length,a&&r(data)}catch(e){return console_log("server.js : local accts data corrupt. redownloading"),o("error"),void get_accts()}var g=get_version(data);if(g!=g_server_accts_version&&-1!=g_server_accts_version)console_log("server.js : local accts version is outdated: local:"+g+" server:"+g_server_accts_version+" redownloading"),get_accts();else{if(L("using cached accts data"),hassites()&&(!t||"refetchsharing"!=t))return L("Cached data already in place, ABORT, to avoid reparse."),void o("abort");var u=[],d=[],c={},_=[],p=[],f={},m=[],h=[],b=[],v=[],y=[],k=[],w={},A=[],x=[],S=[],R=[],C=[];lp_premium_exp=0,lp_enterpriseuser=0;var P=get_ff_translation("ff_captcha_regexp");lp_captcha_regexp=""!=P?new RegExp(P,"i"):null,parsemobile(data,data.length,100,0,postacctsload,u,d,c,_,p,f,m,!0,!0,null,h,b,v,y,k,w,lp_rsaprivatekeyhex,A,null,null,null,x,S,R,C,void 0,void 0,g_emer_sharers,g_emer_sharees,g_totp,g_note_templates,g_pending_shares,g_reminders),g_premium_exp=lp_premium_exp,g_enterpriseuser=lp_enterpriseuser}}else g_username_hash&&get_accts();o()},g=function(e,t){console_log(t),s="error"};if(LPISLOC)read_accts_from_file(function(e){""!=e?l(tx,{rows:{length:1,item:function(t){return{data:e}}}}):l(tx,{rows:{length:0}})});else if(g_indexeddb){var u={rows:{item:function(e){return this[e]},length:0}};i.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_accts")).onsuccess=function(e){var t=e.target.result;t?(u.rows[u.rows.length]=t.value,u.rows.length++,t.continue()):l(0,u)}}else i.transaction(function(e){e.executeSql("SELECT * FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(g_username_hash),"accts"],l,g)})}else get_accts()}function MakeOTP(){if(null!=g_username&&0!=g_username.length&&null!=g_local_key&&0!=g_local_key.length){var e=fix_username(g_username);rng_seed_time();for(var t=new Array,a=0;a<16;a++)t[a]=0;rng_get_bytes(t);for(var r="",a=0;a<16;a++)r+=String.fromCharCode(t[a]);var o=enc(AES.bin2hex(r),g_local_key),n=make_lp_key(g_username,r),s=enc(AES.bin2hex(g_local_key),n),i=SHA256(SHA256(e+r)+r),l=AES.hex2bin(dec(s,n,1))
;if(g_local_key!=l)return void console_log("server.js : ERROR: Failed to decrypt newly encrypted key: dec_local_key:\n"+AES.bin2hex(l)+" != \n"+AES.bin2hex(g_local_key)+"\nlen: "+l.length+" vs "+g_local_key.length+"\nrand pw:"+AES.bin2hex(r)+"\ng_username:"+g_username+"\nrand key:"+AES.bin2hex(n)+"\nrand_encrypted_key:"+s);var g="newkey=1&xml=1&hash="+LP.en(i);g+="&encrypted_otp="+LP.en(o),g+="&rand_encrypted_key="+LP.en(s),g+="&recovery=1",LP.lpMakeRequest(base_url+"otp.php",g,lpOTPUploadResponse,function(){},r)}}function DeleteOTP(){DeleteFromDB("otp")}function DeleteFromDB(e){if(null!=g_username&&""!=g_username&&(!LPISLOC||"key"!=e&&"accts"!=e)){var t=opendb();createDataTable(t),t&&(g_indexeddb?t.transaction("LastPassData","readwrite").objectStore("LastPassData").delete(db_prepend(g_username_hash)+"_"+e):t.transaction(function(t){t.executeSql("DELETE FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(g_username_hash),e],function(e,t){},function(e,t){console_log(t)})}))}}function GetOTPHash(e,t,a,r){e&&(e+="&outofbandsupported=1",isDogfood()&&(e+="&dogfood=1"));var o=opendb();if(createDataTable(o),o){var n=a?SHA256(a):g_username_hash,s=a||g_username,i=function(a,o){var n="";o.rows.length>0&&(n=o.rows.item(0).data),e?(""!=n?(n=AES.hex2bin(n),lostotphash=SHA256(SHA256(fix_username(s)+n)+n)):lostotphash="",1==lpGetPref("storeLostOTP",1)&&(e+="&lostpwotphash="+en(lostotphash)),sesame_setdata("postdata",e),yubikey_setdata("postdata",e),googleauth_setdata("postdata",e),outofband_setdata("postdata",e),securityquestion_setdata("postdata",e),grid_setdata("postdata",e),multifactor_setdata("postdata",e),g_lastpoll=lastlogin=(new Date).getTime(),console_log("server.js : Requesting login.php A"),lpMakeRequest(base_url+"login.php",e,lpLoginResponse,lpLoginError)):null!=t&&(lostotphash=""==n?"nouser":n,sendCS(t,{cmd:"recover",otp:lostotphash},r))};if(g_indexeddb){var l={rows:{item:function(e){return this[e]},length:0}};o.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(n)+"_otp")).onsuccess=function(e){var t=e.target.result;t?(l.rows[l.rows.length]=t.value,l.rows.length++,t.continue()):i(0,l)}}else o.transaction(function(e){e.executeSql("SELECT * FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(n),"otp"],i,function(e,t){console_log(t)})})}else g_lastpoll=lastlogin=(new Date).getTime(),console_log("server.js : Requesting login.php B"),lpMakeRequest(base_url+"login.php",e,lpLoginResponse,lpLoginError)}function lpOTPUploadResponse(e,t,a){if(4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=opendb();createDataTable(r),r&&(g_indexeddb?r.transaction("LastPassData","readwrite").objectStore("LastPassData").put({username_hash:db_prepend(g_username_hash),type:"otp",data:AES.bin2hex(a),usertype:db_prepend(g_username_hash)+"_otp"}):r.transaction(function(e){e.executeSql("REPLACE INTO LastPassData (username_hash, type, data) VALUES (?, ?, ?)",[db_prepend(g_username_hash),"otp",AES.bin2hex(a)],function(e,t){console_log("server.js : inserted")},function(e,t){console_log(t)})}))}}function savePassword(e,t,a,r,o){var n=lp_gettld_url(t);0!=t.indexOf("chrome://")&&0!=t.indexOf("chrome-extension://")||(t="Browser",n="Browser");var s=gs("Generated Password for")+" "+n,i=(new PostParams).add("url",AES.url2hex(t)).add("password",lpenc(e)).add("name",lpenc(s)).add("iid",g_identity).add("method",get_method()).add("token",g_token);r&&i.add("nofill",1);for(prop in o)i.add(prop,o[prop]);lpMakeRequest(base_url+"save_gen_pw.php",i.toString(),lpPopulateGeneratedPassword,null,a)}function lpPopulateGeneratedPassword(e,t,a){if(4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("error");if(o.length>0){var n=o[0].getAttribute("notloggedin");if(n&&"1"==n)return void loggedOut(!1,"lpPopulateGeneratedPassword")}var s=r.getElementsByTagName("ok");if(s.length>0){var i=AES.hex2url(s[0].getAttribute("url")),l=crypto_atob(s[0].getAttribute("password")),g={cmd:"populategeneratedpassword",url:i,password:lpmdec(l,!0),nofill:s[0].getAttribute("nofill"),ff_currpass_regexp:get_ff_translation("ff_currpass_regexp")};sendCS(a,g,"all");var u=createNewAcct();u.tld=lp_gettld_url(i);var d=gs("Generated Password for")+" "+u.tld;u.aid=s[0].getAttribute("aid"),void 0===g_tlds[u.tld]&&(g_tlds[u.tld]={}),g_tlds[u.tld][u.aid]=!0,add_ident_aid(u.aid),u.url=i,u.name=d,u.password=l,u.genpw=1,g_sites[u.aid]=u,g_local_accts_version++,rewritelocalfile();var c=s[0].getAttribute("accts_version");compare_accounts_versions(c,g_local_accts_version)||get_accts(),refresh_windows()}}}function addeditformfill(e,t,a,r){var o=(new PostParams).add("method",get_method()).add("token",g_token).add("iid",g_identity);for(var n in e)o.add(n,e[n]);var s=!1;return void 0!==t.group&&""!=t.group&&(s=issharedfolder(g_shares,t.group)),s&&o.add("sharedfolderid",s.id),lpMakeRequest(base_url+"formfill.php",o.toString(),lpAddEditFormFillResponse,r,{site:t,successCallback:a,errorCallback:r}),!0}function deleteformfill(e,t,a,r,o,n,s){if(a&&!frame_and_topdoc_has_same_domain(r)&&(ftd_report_error(r,"deleteformfill"),!lpConfirmYesNo(gs("Are you sure you would like to delete this Form Fill from your LastPass vault?"))))return!1;var i;if(!t)for(i=0;i<g_formfills.length;i++)if(g_formfills[i].ffid==e){if(g_formfills[i].pwprotect||g_prompts.view_ff_prompt)return security_prompt(function(){deleteformfill(e,!0,a,r,o,n,s)}),!1;break}var l=!1;for(i=0;i<g_formfills.length;i++)if(g_formfills[i].ffid==e){l=issharedfolder(g_shares,void 0!==g_formfills[i].group?g_formfills[i].group:""),g_formfills.splice(i,1);break}g_local_accts_version++,rewritelocalfile();var g=(new PostParams).add("deleteext",1).add("ffid",e).add("method",get_method()).add("iid",g_identity);return s&&g.add("source",s),l&&g.add("sharedfolderid",l.id),lpMakeRequest(base_url+"formfill.php",g.toString(),lpDeleteFormFillResponse,n,{ffid:e,successCallback:o,errorCallback:n}),!0}function lpAddEditFormFillResponse(e,t,a){var r=a.site;if(4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var o=e.responseXML.documentElement,n=o.getElementsByTagName("error");if(n.length>0){var s=n[0].getAttribute("notloggedin");if(s&&"1"==s)return void loggedOut(!1,"lpAddEditFormFillResponse");var i=n[0].getAttribute("response");i&&(a.errorCallback?a.errorCallback(i):alertfrombg(i))}var l=o.getElementsByTagName("result");if(l.length>0){var g,u=(l[0].getAttribute("msg"),l[0].getAttribute("ffid")),d=l[0].getAttribute("cfids"),c=l[0].getAttribute("accts_version"),_=[],p=""==d?[]:d.split(","),f=0;for(g=1;void 0!==r["customfield"+g+"cfid"];++g){var m={};m.cfid=0!=r["customfield"+g+"cfid"]?r["customfield"+g+"cfid"]:f<p.length?p[f++]:0,m.text=r["customfield"+g+"text"],m.value=r["customfield"+g+"value"],m.alttext=r["customfield"+g+"alttext"],""==m.text&&""==m.value&&""==m.alttext||_.push(m)}var h=r.cmd;for(delete r.cmd,delete r.deleteext,g=1;void 0!==r["customfield"+g+"cfid"];++g)delete r["customfield"+g+"cfid"],delete r["customfield"+g+"text"],delete r["customfield"+g+"value"],delete r["customfield"+g+"alttext"];if(r.custom_fields=_,"add"==h)r.ffid=u,add_ident_ffid(u),g_formfills.push(r);else for(g=0;g<g_formfills.length;++g)if(u==g_formfills[g].ffid){g_formfills[g]=r;break}g_formfills.sort(function(e,t){return e.decprofilename.toLowerCase()<t.decprofilename.toLowerCase()?-1:1}),g_local_accts_version++,rewritelocalfile(),compare_accounts_versions(c,g_local_accts_version)||get_accts(),refresh_windows(),a.successCallback&&a.successCallback(r),do_experimental_popupfill&&setTimeout(function(){recheckpage()},50)}}}function lpDeleteFormFillResponse(e,t,a){if(4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("error");if(o.length>0){var n=o[0].getAttribute("notloggedin");if(n&&"1"==n)return void loggedOut(!1,"lpDeleteFormFillResponse")}var s=r.getElementsByTagName("result");if(s.length>0){var i=s[0].getAttribute("accts_version");compare_accounts_versions(i,g_local_accts_version)||get_accts(),refresh_windows(),a.successCallback&&a.successCallback(),do_experimental_popupfill&&setTimeout(function(){recheckpage()},50)}}}function saveSiteFromSubmit(e,t,a,r){var o=(new PostParams).add("auto",1).add("method",get_method()).add("iid",g_identity),n=IntroTutorial.getState();n&&n.enabled&&(o.add("intour","1"),o.add("tile",n.tile));try{for(var s in g_sites)if(g_sites[s].genpw&&g_sites[s].tld==t.tld&&lpmdec_acct(g_sites[s].password,!0,g_sites[s],g_shares)==lpmdec_acct(t.password,!0,t,g_shares)){o.add("delgenpwaid",s),o.add("generated","true");break}}catch(e){}e+="&"+o.toString();var i={url:base_url+"deliver_and_add.php",postdata:e,successCallback:a,errorCallback:r,acct:t};handleOfflineAccountUpdate(i,g_sites,"aid"),lpMakeRequest(i.url,e,lpSaveSiteResponse,r,i)}function updateFieldsFromSubmit(e,t,a,r){e+="&auto=1"+get_identity_param();var o={url:base_url+"gm_deliver.php",postdata:e,acct:t,successCallback:a,errorCallback:r};lpMakeRequest(o.url,e,lpUpdateFieldsResponse,null,o)}function handleOfflineAccountUpdate(e,t,a){if(e.successCallback&&isOffline()){if("0"===e.acct[a]){var r=Preferences.get("tempID")+1;e.acct[a]=r.toString(),Preferences.set("tempID",r)}t[e.acct[a]]=e.acct,e.successCallback(e.acct),increment_local_accts_version(),rewritelocalfile(),delete e.successCallback,delete e.errorCallback}}function saveAllSite(e,t,a,r){e+="&"+(new PostParams).add("auto",1).add("method",get_method()).add("iid",g_identity).toString();var o={url:base_url+"show.php",postdata:e,successCallback:a,errorCallback:r,acct:t};handleOfflineAccountUpdate(o,g_sites,"aid"),lpMakeRequest(o.url,e,lpSaveSiteResponse,o.errorCallback,o)}function saveSite(e,t,a,r){var o=(new PostParams).add("auto",1).add("method",get_method()).add("iid",g_identity);try{for(var n in g_sites)if(g_sites[n].genpw&&g_sites[n].tld==t.tld&&lpmdec_acct(g_sites[n].password,!0,g_sites[n],g_shares)==lpmdec_acct(t.password,!0,t,g_shares)){o.add("delgenpwaid",n),o.add("generated","true");break}}catch(e){}e+="&"+o.toString();var s=is_application(t),i=(s?t.appaid:t.aid,{url:base_url+(s?"addapp.php":"show.php"),postdata:e,successCallback:a,errorCallback:r,acct:t});handleOfflineAccountUpdate(i,t.sn?g_securenotes:s?g_applications:g_sites,s?"appaid":"aid"),lpMakeRequest(i.url,e,lpSaveSiteResponse,i.errorCallback,i)}function openLinkedSites(e,t,a){setTimeout(function(){openchangepw(e,t,a)},700)}function lpSaveSiteResponse(e,t,a){if(a.aid=a.acct.aid,a.newvalues=a.acct.newvalues,a.handler=lpSaveSiteResponse,!rsa_shareeautopushesresponse(e,a)&&4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=a.acct,o=e.responseXML.documentElement,n=o.getElementsByTagName("error");if(n.length>0){var s=n[0].getAttribute("notloggedin");if(s&&"1"==s)return void loggedOut(!1,"lpSaveSiteResponse");var i=n[0].getAttribute("response");i&&(a.errorCallback?a.errorCallback(i):alertfrombg(i))}var l=o.getElementsByTagName("result");if(l.length>0){var g=l[0].getAttribute("msg"),u=0;("accountreplaced"==g||a.successCallback)&&u++,r.submit_id=l[0].getAttribute("submit_id"),r.captcha_id=l[0].getAttribute("captcha_id"),r.custom_js=l[0].getAttribute("custom_js");var d=l[0].getAttribute("attacherror");for(d&&""!=d&&alertfrombg(d),checkIconsVersion(),checkBigIconsVersion(r.posturl),checkBigIconsVersion(r.posturl,null,null,"sq"),inc=0,newattach=Array();null!=l[0].getAttribute("att_"+inc);)newattach[l[0].getAttribute("att_"+inc)]=Array(),newattach[l[0].getAttribute("att_"+inc)].key=l[0].getAttribute("attstorekey_"+inc),newattach[l[0].getAttribute("att_"+inc)].size=l[0].getAttribute("attsize_"+inc),inc++;var c=is_application(r)?"0"===r.appaid:"0"===r.aid;if(c){var _=l[0].getAttribute("aid"),p=l[0].getAttribute("urid");if(r.aid=r.fiid=_,r.urid=p,r.fields){var f,m=get_ff_translation("ff_captcha_regexp");f=""!=m?new RegExp(m,"i"):null;for(var h=0;h<r.fields.length;h++)r.fields[h].otherfield||"1"==r.fields[h].otherlogin||(r.fields[h].urid=p),f&&(void 0===r.captcha_id||""==r.captcha_id)&&"text"==r.fields[h].type&&f.exec(r.fields[h].name)&&(r.captcha_id=r.fields[h].name)}add_ident_aid(r.aid),r.sn?g_securenotes[r.aid]=r:(void 0!==r.tld&&""!=r.tld||(r.tld=lp_gettld_url(r.url)),void 0===g_tlds[r.tld]&&(g_tlds[r.tld]={}),g_tlds[r.tld][r.aid]=!0,g_sites[r.aid]=r);for(var h in g_sites)g_sites[h].genpw&&g_sites[h].tld==r.tld&&lpmdec_acct(g_sites[h].password,!0,g_sites[h],g_shares)==lpmdec_acct(r.password,!0,r,g_shares)&&(void 0!==g_tlds[g_sites[h].tld]&&void 0!==g_tlds[g_sites[h].tld][h]&&delete g_tlds[g_sites[h].tld][h],delete g_sites[h]);var b=o.getElementsByTagName("field");if(b&&b.length>0){r.fields=new Array;for(var h=0;h<b.length;h++){var v=b[h],y={};if(y.name=v.getAttribute("name"),y.type=v.getAttribute("type"),y.value=v.getAttribute("value"),is_encrypted_field(y.type))y.value=crypto_atob(y.value);else if("checkbox"==y.type||"radio"==y.type){y.checked=!1;var k=y.value.match(/-([0-1])$/);k&&("1"==k[1]&&(y.checked=!0),y.value=y.value.substring(0,y.value.length-2))}y.formname="",r.fields[h]=y}u++}}if(void 0===r.attacharraychanges||d&&""!=d)d&&""!=d&&void 0!==r.attacharraychanges&&rollbackattacharrayadds(r.attacharraychanges);else{if(void 0!==r.attacharraychanges.add)for(var h in r.attacharraychanges.add)if(r.attacharraychanges.add.hasOwnProperty(h)){r.attachpresent="1";var w=r.attacharraychanges.add[h];c&&(w.parent=r.aid,w.id=r.aid+"-"+w.id),w.size=newattach[w.id].size,w.storagekey=newattach[w.id].key}applyattacharraychanges(r.attacharraychanges),r.attacharraychanges={}}var A=l[0].getAttribute("accts_version");if(g_local_accts_version+=u,compare_accounts_versions(A,g_local_accts_version)?rewritelocalfile():get_accts(),void 0!==r.retrieveattach&&1==r.retrieveattach){var L=function(){console.log("lpSaveSiteResponse : attachversion="+attachversion+" > lp_local_attach_version="+lp_local_attach_version+" --- calling getattach.php");var e="version="+LP.en(lp_local_attach_version)+"&b64=1&chunked=1";LP.lpMakeRequest(base_url+"getattach.php",e,lpSaveAttach)};null==lp_local_attach_version||-1==lp_local_attach_version?ReadFileGeneric(lpusername_hash+"_version.att",25,function(e){lp_local_attach_version=e,lp_local_attach_version||(lp_local_attach_version=0),L()}):L(),r.retrieveattach=null}refresh_windows(),a.successCallback&&(r.sn?g_securenotes[r.aid]=r:is_application(r)?g_applications[r.appaid]=r:(g_sites[r.aid]=r,Topics.get(Topics.SITE_ADDED).publish(r)),a.successCallback(r)),do_experimental_popupfill&&(setTimeout(function(){recheckpage()},50),!LPContentScriptFeatures.new_save_site&&"undefined"!=typeof g_show_save_success_msg&&g_show_save_success_msg&&(doPopupSaveOK(g_popup_tabid_save),g_popup_tabid_save=null))}}}function lpUpdateFieldsResponse(e,t,a){if(a.aid=a.acct.aid,a.newvalues=a.acct.newvalues,a.handler=lpUpdateFieldsResponse,!rsa_shareeautopushesresponse(e,a)&&4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=a.acct,o=e.responseXML.documentElement,n=o.getElementsByTagName("error");if(n.length>0){var s=n[0].getAttribute("notloggedin");if(s&&"1"==s)return void loggedOut(!1,"lpUpdateFieldsResponse")}var i=o.getElementsByTagName("ok");if(i.length>0){var l=i[0].getAttribute("accts_version");if(compare_accounts_versions(l,g_local_accts_version)){var g=i[0].getAttribute("urid"),u="0"==r.urid,d=!u;if(u&&(r.urid=g),r.fields)for(var c=0;c<r.fields.length;c++)u&&!r.fields[c].otherfield&&"1"!=r.fields[c].otherlogin?r.fields[c].urid=g:d&&!r.fields[c].otherfield&&"1"==r.fields[c].otherlogin&&"0"==r.fields[c].urid&&(r.fields[c].urid=g)}else get_accts();refresh_windows(),a.successCallback&&a.successCallback(a.acct)}else a.errorCallback&&a.errorCallback()}}function addNever(e){g_neverurls.neveraccounts.push(e),g_local_accts_version++,rewritelocalfile();var t="url="+en(url2hex(e));lpMakeRequest(base_url+"add_never.php",t,null,null)}function deleteGroup(e,t,a,r,o,n,s){var i=void 0===n?null:n;s=s||!1;var l=(issharedfolder(g_shares,e),"");for(var g in g_sites)g_sites[g].group==e&&(l+=(""==l?"":",")+g);for(var g in g_securenotes)g_securenotes[g].group==e&&(l+=(""==l?"":",")+g);for(var g in g_applications)g_applications[g].group==e&&(l+=(""==l?"":",")+"app"+g);if(""==l&&!o)return deleteGroup("\\"+e,t,a,"deleteGroup",1,i);if(""==l&&1==o){if(null==i)return void console_log("server.js : Failed to find group and groupid is null");var u=null,l="";for(var g in g_sites)if(g_sites[g].id==i){u=g_sites[g].group;break}if(null==u)for(var g in g_securenotes)if(g_securenotes[g].id==i){u=g_securenotes[g].group;break}if(null==u)for(var g in g_applications)if(g_applications[g].id==i){u=g_applications[g].group;break}if(null!=u){for(var g in g_sites)g_sites[g].group==e&&(l+=(""==l?"":",")+g);for(var g in g_securenotes)g_securenotes[g].group==e&&(l+=(""==l?"":",")+g);for(var g in g_applications)g_applications[g].group==e&&(l+=(""==l?"":",")+"app"+g)}""==l&&(l=i,console_log("server.js : Still couldn't find stuff -- just using the passed groupid : aids="+l))}return deleteAid(l,t,!1,s,a,e)}function checkmultiplefolders(e){for(var t=!1,a=null,r=!0,o=0;o<e.length;o++){var n=e[o],s=get_record(n);if(s){var i=issharedfolder(g_shares,s.group);if(i){if(t){r=!1;break}if(null==a)a=i.decsharename;else if(a!=i.decsharename){r=!1;break}}else{if(null!=a){r=!1;break}t=!0}}}return r||alertfrombg(gs("Sorry, you cannot perform this operation on a mix of shared and non-shared folders, or multiple shared folders at once.")),r}function deleteAid(e,t,a,r,o,n,s,i){if(s&&!frame_and_topdoc_has_same_domain(i)){var l=get_record(e),g="";if(l&&(g=l.useusername,g||l.unencryptedUsername,g||l.sitename,g||l.name),ftd_report_error(i,"deleteaid"),!lpConfirmYesNo(gs("Are you sure you would like to delete this site from your LastPass vault?")+"\n\n"+g))return!1}var u=e.split(",");if(!checkmultiplefolders(u))return!1;for(var d="",c=0,_=0;_<u.length;_++){var p=u[_];if(is_application(p)){if(!check_ident_appaid(p))continue}else if(!check_ident_aid(p))continue;var f,m;if(is_application(p)?(f=get_record(p),m=!1):(f=g_sites[p],m=g_prompts.edit_site_prompt,f||(m=g_prompts.edit_sn_prompt,f=g_securenotes[p])),f){if(d+=(""==d?"":",")+p,void 0!==f.sharefolderid){c=f.sharefolderid;var h=issharedfolder(g_shares,f.group);if(!checkreadonly(h))return!1}if(!a&&(f.pwprotect||m))return security_prompt(function(){deleteAid(e,t,!0,r,o)}),!1}}if(""==d)return!1;var b=gs("Are you sure you would like to delete this site?");if(f.genpw?b=gs("Are you sure you would like to delete this generated password?"):f.sn?b=gs("Are you sure you would like to delete this secure note?"):is_application(f)&&(b=gs("Are you sure you would like to delete this application?")),f.name&&f.name.length&&(b+=" ("+f.name+")"),u.length>1&&(b=gs("Are you sure you would like to delete the selected items?")),f.group&&"http://group"==f.url&&(b=gs("Are you sure you would like to delete this group?")+" ("+f.group+")"),!r)try{if(null==t){if(!g_isopera&&!confirm(b))return!1}else if(!g_isopera&&!t.confirm(b))return!1}catch(e){}for(var v=d.split(","),y="",_=0;_<v.length;_++){var p=v[_];if(is_application(p))delete g_applications[get_appaid(p)];else{if(!f.sn&&"http://group"!=f.url)try{delete g_tlds[f.tld][p],8==(8&g_loglogins)&&(y+=(""==y?"":",")+getusernamefromacct(g_sites[p]))}catch(e){}delete g_sites[p],delete g_securenotes[p]}}g_local_accts_version++,rewritelocalfile();var k="ajax=1&extjs=1&delete=1&aid="+en(d);return k+=get_identity_param(),0!=c&&(k+="&sharedfolderid="+en(c)),""!=y&&(k+="&un="+en(AES.url2hex(y))),lpMakeRequest(base_url+"show.php",k,lpDeleteResponse),o&&o(),!0}function lpDeleteResponse(e){if(e&&4==e.readyState&&200==e.status&&null!=e.responseXML&&null!=e.responseXML.documentElement){var t=e.responseXML.documentElement,a=t.getElementsByTagName("result");if(a.length>0){var r=a[0].getAttribute("accts_version");compare_accounts_versions(r,g_local_accts_version)||get_accts(),refresh_windows()}}}function editAid(e,t,a,r){if(check_ident_aid(e))if(VaultToggle.useVault4_0()&&!r)g_sites[e]?LPPlatform.openTabDialog("site",{vaultItem:e}):is_application(e)?LPPlatform.openTabDialog("application",{vaultItem:0===e.indexOf("app")?e.substring(3):e}):LPPlatform.openTabDialog("note",{vaultItem:e});else{var o,n;if(is_application(e)?(o=get_record(e),n=!1):(o=g_sites[e],n=g_prompts.edit_site_prompt,o||(n=g_prompts.edit_sn_prompt,o=g_securenotes[e])),!o)return;if(!a&&(o.pwprotect||n))return void(o.pwprotect?security_prompt(function(){editAid(e,t,!0,r)},null,null,!0,e):security_prompt(function(){editAid(e,t,!0,r)}));g_site_data=new Array;for(var s in o)g_site_data[s]=o[s];g_site_data.openchpw="1"==r&&"1"==g_site_data.pwch?1:0;var i=0,l=!1;if(void 0!==o.attachpresent&&"1"==o.attachpresent){g_site_data.attaches=[];for(var s in lp_attaches)lp_attaches[s].parent==e&&i++;for(var s in lp_attaches)lp_attaches[s].parent==e&&(0==lp_attaches[s].mimetype.indexOf("data:image")?(l=!0,function(e){lpReadAttach(lp_attaches[e].id,function(t){var a=t;g_site_data.attaches[g_site_data.attaches.length]={id:lp_attaches[e].id,mimetype:lp_attaches[e].mimetype,filename:lp_attaches[e].filename,bytes:a},g_site_data.attaches.length==i&&openURL(getchromeurl("site.html"))})}(s)):(g_site_data.attaches[g_site_data.attaches.length]={id:lp_attaches[s].id,mimetype:lp_attaches[s].mimetype,filename:lp_attaches[s].filename,bytes:null},l&&g_site_data.attaches.length==i&&openURL(getchromeurl("site.html"))))}l||openURL(getchromeurl("site.html"))}}function saveFields(e,t,a,r,o){if(a&&a.newvalues&&void 0===a.newvalues.length){var n=[];for(var s in a.newvalues)n.push(a.newvalues[s]);a.newvalues=n}a=a||{},a.successCallback=r,a.errorCallback=o,a.url=base_url+"fields.php?"+e,a.postdata=t,lpMakeRequest(a.url,t,lpSaveFieldsResponse,o,a)}function lpSaveFieldsResponse(e,t,a){if(a.handler=lpSaveFieldsResponse,!rsa_shareeautopushesresponse(e,a)&&4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("response");if(o.length>0){var n=o[0].getAttribute("message");console_log("server.js : Save Fields failed: "+n)}var s=r.getElementsByTagName("error");if(s.length>0){var i=s[0].getAttribute("notloggedin");if(i&&"1"==i)return void loggedOut(!1,"lpSaveFieldsResponse")}var l=r.getElementsByTagName("result");if(l.length>0){var g=l[0].getAttribute("accts_version");compare_accounts_versions(g,g_local_accts_version)||get_accts(),refresh_windows(),a&&a.successCallback&&a.successCallback()}}}function poll_server_request(){if(!(null!=g_lastpoll&&g_lastpoll>(new Date).getTime()-2)&&(g_lastpoll=(new Date).getTime(),lploggedin&&null==grid_getdata("active"))){var e=pollserver_url+"poll_server.php",t="";if(lpsendmpstrength&&null!=lpmpstrength&&(t+="&mpstrength="+LP.en(lpmpstrength)),1==g_prompts.improve)for(var a in g_events)g_events.hasOwnProperty(a)&&(t+="&"+LP.en(a)+"="+LP.en(g_events[a]));g_events=[],lpMakeRequest(e,t,poll_server_response,null),g_lastpoll=(new Date).getTime()}}function poll_server(){if(!g_nopoll){if(lploggedin&&null==grid_getdata("active")){var e=(new Date).getTime(),t=lpGetPref("logOffAfterLoggedInVal",0);if(t>0&&e-lastlogin>60*t)return lplogoff(!1,"logoffafterloggedin"),void setTimeout(function(){poll_server()},6e4);g_lastpollcheck=e,1==lpGetPref("logoffWhenCloseBrowser",0)&&lpGetPref("logoffWhenCloseBrowserVal",0)>0&&(lpPutUserPref("lastpollcheck",g_lastpollcheck),lpWriteAllPrefs());var a=60*parseInt(lpGetPref("pollServerVal",15)),r=1e3*a,o=function(t){"locked"!=t&&"idle"!=t||(r*=g_logoff_other_ses?12:60),e-g_lastpoll>=r&&poll_server_request()};if(r>0){var n=function(e){e?call_binary_function("get_idle_ms",function(e){o(e>=r?"idle":"active")}):enable_native_idle&&"undefined"!=typeof chrome&&void 0!==chrome.idle?chrome.idle.queryState(a,o):o("active")};have_binary_function("get_idle_ms")?can_check_idle(n):n(!1)}}setTimeout(function(){poll_server()},6e4)}}function handlenotifications(e,t,a){try{if(lplog("notify: title="+e+" text="+t+" url="+a),"undefined"!=typeof webkitNotifications&&webkitNotifications)if(0!=webkitNotifications.checkPermission())lplog("notify: requesting permission"),webkitNotifications.requestPermission(function(){lplog("notify: requesting permission callback called")});else{var r=webkitNotifications.createNotification("images/icon48.png",e,t);if(r){var o=(new Date).getTime()+"_"+Math.floor(100*Math.random());r.ondisplay=function(){lplog("notify: displaying notification id="+o)},r.onclose=function(){lplog("notify: closing notification id="+o)},r.onclick=function(){lplog("notify: user clicked notification id="+o),a&&""!=a&&(lplog("notify: opening notication url for id="+o+" url="+a),r.cancel(),openURL(a))},r.show(),g_notifications.push({id:o,time:(new Date).getTime(),note:r}),1==g_notifications.length&&setTimeout(function(){notifications_autoclose()},0)}else lplog("notify: error : failed to create notification")}else g_isfirefoxsdk?g_ff_notifications.notify({title:e,text:t,iconURL:self.data.url("images/icon48.png"),onClick:function(e){e&&""!=e&&openURL(e)},data:a}):lplog("notify: error: webkitNotifications is null")}catch(e){}}function notifications_autoclose(){return}function notifications_closeall(){lplog("notify: closing all notifications");for(var e=0;e<g_notifications.length;++e)lplog("notify: closing notification id="+g_notifications[e].id),g_notifications[e].note.cancel();g_notifications=[]}function poll_server_response(e){if(4==e.readyState)if(200==e.status&&null!=e.responseXML&&null!=e.responseXML.documentElement){var t=e.responseXML.documentElement,a=t.getElementsByTagName("ok");if(a.length>0){g_logoff_other_ses="1"==a[0].getAttribute("logoff_other_ses");var r=a[0].getAttribute("accts_version"),o=(a[0].getAttribute("newbreach"),a[0].getAttribute("newalert"));a[0].getAttribute("newbreach_msg");"true"==o&&handle_new_alerts(a[0]),g_server_accts_version=r,r>g_local_accts_version&&get_accts();var n=a[0].getAttribute("attachversion"),s=function(){if(n>lp_local_attach_version){console.log("poll_server_response : attachversion="+n+" > lp_local_attach_version="+lp_local_attach_version+" --- calling getattach.php");var e="version="+LP.en(lp_local_attach_version)+"&b64=1&chunked=1";LP.lpMakeRequest(base_url+"getattach.php",e,lpSaveAttach)}};null==lp_local_attach_version||-1==lp_local_attach_version?ReadFileGeneric(lpusername_hash+"_version.att",25,function(e){lp_local_attach_version=e,lp_local_attach_version||(lp_local_attach_version=0),s()}):s(),lpsendmpstrength=null!=a[0].getAttribute("sendmpstrength");var i=a[0].getAttribute("note_title");if(i&&i.length){var l=a[0].getAttribute("note_text"),g=a[0].hasAttribute("note_url")?a[0].getAttribute("note_url"):null;handlenotifications(i,l,g)}}}else{var u="Problem in poll_server_response. status="+e.status;lpReportError(u,null)}}function upgrade_response(e){if(4==e.readyState)if(200==e.status&&null!=e.responseXML&&null!=e.responseXML.documentElement){var t=e.responseXML.documentElement,a=t.getElementsByTagName("updatecheck");a.length>0?(upgrade="1"==a[0].getAttribute("upgrade"),upgradeurl=a[0].getAttribute("codebase")):(upgrade=!1,upgradeurl=""),g_ischrome?(g_notification_type="upgrade",g_notification_data={upgrade:upgrade,upgradeurl:upgradeurl},sendTS({cmd:"notification",type:"upgrade"})):(g_issafari||g_isopera||g_ismaxthon||g_isfirefoxsdk)&&(upgrade?confirm(gs("An Update is Available. Would you like to install?"))&&openURL(upgradeurl):alertfrombg(gs("No Updates Are Available")))}else{var r="Problem in upgrade_response. status="+e.status;lpReportError(r,null)}}function changePassword(e,t,a,r,o){debug&&console_log("changePassword called");var n=[];n.push(e);for(var s=new Array,i=0,l=0;l<t.length;l++)g_sites[t[l]]?(lpmdec_acct(g_sites[t[l]].password,!0,g_sites[t[l]],g_shares)!=e&&(s[s.length]=t[l]),void 0!==g_sites[t[l]].sharefolderid&&(i=g_sites[t[l]].sharefolderid)):debug&&console_error("skipping bad aid in changePassword "+t[l]);if(t=s,0!=t.length){g_pending_pw_change={};for(var g="xml=1",u=new Array,d="",l=0;l<t.length;l++){var c=l>0?l:"";g+="&username"+c+"=dummy",g+="&password"+c+"="+LP.en(lpenc_acct(e,g_sites[t[l]],g_shares)),g+="&id"+c+"="+LP.en(t[l]),8==(8&g_loglogins)&&(d+=(""==d?"":",")+getusernamefromacct(g_sites[t[l]])),n.push(e),g_pending_pw_change[t[l]]=lpenc_acct(e,g_sites[t[l]],g_shares);try{lp_in_array(g_sites[t[l]].tld,u)||(u[u.length]=g_sites[t[l]].tld)}catch(e){}}try{for(var l in g_sites)if(g_sites[l].genpw&&lp_in_array(g_sites[l].tld,u)&&lpmdec_acct(g_sites[l].password,!0,g_sites[l],g_shares)==e){g+="&delgenpwaid="+LP.en(l);break}}catch(e){}0!=i&&(g+="&sharedfolderid="+en(i)),""!=d&&(g+="&un="+en(AES.url2hex(d))),void 0!==a&&a&&(g+="&autochange=1");var _={aid:0,postdata:g,url:base_url+"change_pw.php",newvalues:n,successCallback:r,errorCallback:o};lpMakeRequest(_.url,g,lpChangePasswordResponse,o,_)}}function lpChangePasswordResponse(e,t,a){if(a.handler=lpChangePasswordResponse,!rsa_shareeautopushesresponse(e,a)&&4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok");if(o.length>0){if(debug){var n=(new Date).getTime();console_log("received ok response from Password Change at "+n)}for(var s=crypto_atob(o[0].getAttribute("newpassword")),i=new Array,l="";o[0].hasAttribute("oldpassword"+l);){var g=o[0].getAttribute("id"+l),u=crypto_atob(o[0].getAttribute("oldpassword"+l)),d=g_sites[g];if(lp_in_array(d.tld,i)||(i[i.length]=d.tld),debug&&L("acct.password="+d.password+" oldpassword="+u+" newpassword="+s),d.password!=u&&lpmdec_acct(d.password,!0,d,g_shares)!=lpmdec_acct(u,!0,d,g_shares)||(d.password=s),d.fields)for(var c=0;c<d.fields.length;c++)"password"!=d.fields[c].type||d.fields[c].value!=u&&lpmdec_acct(d.fields[c].value,!0,d,g_shares)!=lpmdec_acct(u,!0,d,g_shares)||(d.fields[c].value=s);delete g_pending_pw_change[d.aid],d.last_pwchange_gmt=parseInt((new Date).getTime()/1e3),""==l?l=1:l++}for(var c in g_sites)g_sites[c].genpw&&lp_in_array(g_sites[c].tld,i)&&lpmdec_acct(g_sites[c].password,!0,g_sites[c],g_shares)==lpmdec(s,!0)&&(verbose_log(sprintf("CHG: deleting generated password entry id=%s for password=%s",c,g_show_pw_in_logs||g_isadmin?lpmdec(s,!0):"REDACTED")),void 0!==g_tlds[g_sites[c].tld]&&void 0!==g_tlds[g_sites[c].tld][c]&&delete g_tlds[g_sites[c].tld][c],delete g_sites[c]);g_local_accts_version++,rewritelocalfile(),a.successCallback&&a.successCallback();var _=o[0].getAttribute("accts_version");compare_accounts_versions(_,g_local_accts_version)||get_accts()}else a.errorCallback&&a.errorCallback()}}function yubikey_getotp(e,t){grid_setdata("active","1"),lpdbg("yubikey","Asking user for fresh otp");var a=t&&t.getAttribute("trustexpired")?t.getAttribute("trustexpired"):0,r=t&&t.getAttribute("trustlabel")?t.getAttribute("trustlabel"):"",o={otp:"",username:e};return openURL(getchromeurl("lp_toolstrip.html?browseraction=1&yubikey=1&trustexpired="+encodeURIComponent(a)+"&trustlabel="+encodeURIComponent(r))),o.otp}function yubikey_setdata(e,t){lpyubidata[e]=t}function yubikey_getdata(e){return void 0===lpyubidata[e]?null:lpyubidata[e]}function yubikey_cleardata(){lpdbg("yubikey","clearing data"),lpyubidata={}}function yubikey_auth(e,t){if(grid_setdata("active",null),""!=e){if("1"==yubikey_getdata("offline")){var a=e.substring(0,12);return e=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+a)+a)),yubikey_setdata("password_offline",e),offlineloginsuccessful("offline",0),lpReadAcctsData(),void yubikey_setdata("offline","0")}var r=null,o=null,n=null,s=null;yubikey_getdata("postdata")?(r=yubikey_getdata("postdata")+"&otp="+encodeURIComponent(e),o="login.php",n=lpLoginResponse,s=lpLoginError):(r=sesame_getdata("logincheckpostdata")+"&otp="+encodeURIComponent(e),o="login_check.php",n=lpLoginCheckResponse,s=lpLoginCheckError),""!=t&&(r+="&trustlabel="+encodeURIComponent(t));var i=yubikey_getdata("fromwebsite");console_log("server.js : Requesting "+o+" C"),lpMakeRequest(base_url+o,r,n,s,i)
}else lpshowError("LoginError",!1,!0),loggedOut(!1,"yubikey_auth_error")}function googleauth_getotp(e,t){grid_setdata("active","1"),lpdbg("googleauth","Asking user for fresh otp");var a=t&&t.getAttribute("trustexpired")?t.getAttribute("trustexpired"):0,r=t&&t.getAttribute("trustlabel")?t.getAttribute("trustlabel"):"",o={otp:"",username:e};return openURL(getchromeurl("lp_toolstrip.html?browseraction=1&googleauth=1&trustexpired="+encodeURIComponent(a)+"&trustlabel="+encodeURIComponent(r))),o.otp}function googleauth_setdata(e,t){lpgoogleauthdata[e]=t}function googleauth_getdata(e){return void 0===lpgoogleauthdata[e]?null:lpgoogleauthdata[e]}function googleauth_cleardata(){lpdbg("googleauth","clearing data"),lpgoogleauthdata={}}function googleauth_auth(e,t){if(grid_setdata("active",null),""!=e){if("1"==googleauth_getdata("offline")){var a=e.substring(0,12);return e=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+a)+a)),googleauth_setdata("password_offline",e),offlineloginsuccessful("offline",0),lpReadAcctsData(),void googleauth_setdata("offline","0")}var r=null,o=null,n=null,s=null;googleauth_getdata("postdata")?(r=googleauth_getdata("postdata")+"&otp="+encodeURIComponent(e),o="login.php",n=lpLoginResponse,s=lpLoginError):(r=sesame_getdata("logincheckpostdata")+"&otp="+encodeURIComponent(e),o="login_check.php",n=lpLoginCheckResponse,s=lpLoginCheckError),""!=t&&(r+="&trustlabel="+encodeURIComponent(t));var i=googleauth_getdata("fromwebsite");console_log("server.js : Requesting "+o+" C"),lpMakeRequest(base_url+o,r,n,s,i)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"googleauth_auth_error")}function outofband_getotp(e,t){grid_setdata("active","1"),lpdbg("outofband","Asking user for fresh otp");var a=t&&t.getAttribute("trustexpired")?t.getAttribute("trustexpired"):0,r=t&&t.getAttribute("trustlabel")?t.getAttribute("trustlabel"):"",o={otp:"",username:e};return g_trustlabel="","1"==t.getAttribute("preferduowebsdk")?(lpTurnOffIcon(),openbaseurl("duo.php?canexpire=1&cansetuuid=1&username="+encodeURIComponent(g_username)+"&trustexpired="+encodeURIComponent(a)+"&trustlabel="+encodeURIComponent(r))):openURL(getchromeurl("lp_toolstrip.html?browseraction=1&outofband=1&trustexpired="+encodeURIComponent(t.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(t.getAttribute("trustlabel"))+"&capabilities="+encodeURIComponent(t.getAttribute("capabilities"))+"&allowtrust="+encodeURIComponent(t.getAttribute("allowtrust"))+"&smshash="+encodeURIComponent(t.getAttribute("smshash"))+"&smstime="+encodeURIComponent(t.getAttribute("smstime"))+"&smsuid="+encodeURIComponent(t.getAttribute("smsuid"))+"&outofbandimage="+encodeURIComponent(AES.bin2hex(t.getAttribute("outofbandimage")))+"&sms_nextcode="+encodeURIComponent(t.getAttribute("sms_nextcode"))+"&textoverride="+encodeURIComponent(t.getAttribute("textoverride")))),o.otp}function outofband_setdata(e,t){lpoutofbanddata[e]=t}function outofband_getdata(e){return void 0===lpoutofbanddata[e]?null:lpoutofbanddata[e]}function outofband_cleardata(){lpdbg("outofband","clearing data"),lpoutofbanddata={}}function outofband_handler(e,t,a){if(!g_otpwin_closed)if(e&&4==e.readyState&&200==e.status&&e.responseText.indexOf("outofbandrequired")>0){if(null!=e.responseXML&&null!=e.responseXML.documentElement){var r=e.responseXML.documentElement.getElementsByTagName("error");if(r.length>0){var o=r[0].getAttribute("retryid");if(o&&""!=o){var n=(new Date).getTime();n-g_last_otpcheck>=5e3&&(postdata=outofband_getdata("postdata")+"&outofbandrequest=1&outofbandretry=1&outofbandretryid="+encodeURIComponent(o),g_last_otpcheck=(new Date).getTime(),lpMakeRequest(base_url+"login.php",postdata,outofband_handler,t,a))}}}}else g_otpcheck_complete=!0,closecurrenttab("lp_toolstrip.html?browseraction=1&outofband=1"),lpLoginResponse(e,t,a),""!=g_trustlabel&&null!=e.responseXML&&null!=e.responseXML.documentElement&&e.responseXML.documentElement.getElementsByTagName("ok").length>0&&getuuid(function(e){lpMakeRequest(base_url+"trust.php","canexpire=1&cansetuuid=1&uuid="+encodeURIComponent(e)+"&trustlabel="+encodeURIComponent(g_trustlabel),function(e){if(e&&4==e.readyState&&200==e.status&&e.responseXML&&e.responseXML.documentElement){var t=e.responseXML.documentElement.getElementsByTagName("ok");if(t&&t.length>0&&t[0].hasAttribute("trustuuid")){var a=t[0].getAttribute("trustuuid");a&&""!=a&&setuuid(a,g_username_hash)}}}),g_trustlabel=""},g_username_hash)}function outofband_auth(e,t){if(grid_setdata("active",null),""!=e){if(g_otpcheck_complete="dummy"!=e,g_otpwin_closed="dummy"!=e,"1"==outofband_getdata("offline")){var a=e.substring(0,12);return e=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+a)+a)),outofband_setdata("password_offline",e),offlineloginsuccessful("offline",0),lpReadAcctsData(),void outofband_setdata("offline","0")}var r=null,o=null,n=null;outofband_getdata("postdata")?(r=outofband_getdata("postdata"),o="login.php",lpLoginResponse,n=lpLoginError):(r=sesame_getdata("logincheckpostdata"),o="login_check.php",lpLoginCheckResponse,n=lpLoginCheckError),"dummy"!=e&&(r+="&otp="+encodeURIComponent(e)),""!=t&&(r+="&trustlabel="+encodeURIComponent(t)),r+="&outofbandrequest=1";var s=outofband_getdata("fromwebsite");console_log("server.js : Requesting "+o+" C"),g_last_otpcheck=(new Date).getTime(),lpMakeRequest(base_url+o,r,"dummy"==e?outofband_handler:lpLoginResponse,n,s)}else g_otpcheck_complete||(g_otpwin_closed=!0,lpshowError("LoginError",!1,!0),loggedOut(!1,"outofband_auth_error"))}function securityquestion_getotp(e,t){if(t.getAttribute("redirecturl"))return void openURL(t.getAttribute("redirecturl"));grid_setdata("active","1"),lpdbg("securityquestion","Asking user for fresh otp");var a={otp:"",username:e};return getuuid(function(e){openURL(getchromeurl("lp_toolstrip.html?browseraction=1&securityquestion=1&trustexpired="+encodeURIComponent(t.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(t.getAttribute("trustlabel"))+"&uuid="+encodeURIComponent(e)+"&question="+encodeURIComponent(t.getAttribute("question"))+"&autotrust="+encodeURIComponent(t.getAttribute("autotrust"))+"&hidedisable="+encodeURIComponent(t.getAttribute("hidedisable"))+"&reseturl="+encodeURIComponent(t.getAttribute("reseturl")))),securityquestion_setdata("reseturl",t.getAttribute("reseturl"))},g_username_hash),a.otp}function securityquestion_setdata(e,t){lpsecurityquestiondata[e]=t}function securityquestion_getdata(e){return void 0===lpsecurityquestiondata[e]?null:lpsecurityquestiondata[e]}function securityquestion_cleardata(){lpdbg("securityquestion","clearing data"),lpsecurityquestiondata={}}function securityquestion_auth(e,t){if(grid_setdata("active",null),""!=e){if("1"==securityquestion_getdata("offline")){var a=e.substring(0,12);return e=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+a)+a)),securityquestion_setdata("password_offline",e),offlineloginsuccessful("offline",0),lpReadAcctsData(),void securityquestion_setdata("offline","0")}var r=null,o=null,n=null,s=null;securityquestion_getdata("postdata")?(r=securityquestion_getdata("postdata")+"&otp="+encodeURIComponent(e),o="login.php",n=lpLoginResponse,s=lpLoginError):(r=sesame_getdata("logincheckpostdata")+"&otp="+encodeURIComponent(e),o="login_check.php",n=lpLoginCheckResponse,s=lpLoginCheckError),""!=t&&(r+="&trustlabel="+encodeURIComponent(t));var i=securityquestion_getdata("fromwebsite");console_log("server.js : Requesting "+o+" C"),lpMakeRequest(base_url+o,r,n,s,i)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"securityquestion_auth_error")}function sesame_setotp(e){lpdbg("sesame","browser forwarded OTP => sesame_setotp called"),lpsesameotp=e}function sesame_getotp(e,t){if(grid_setdata("active","1"),e&&lpsesameotp){lpdbg("sesame","Not requesting OTP - using value passed to browser");var a=lpsesameotp;return lpsesameotp=null,sesame_auth(a,""),a}lpdbg("sesame","Asking user for fresh otp");var r=t&&t.getAttribute("trustexpired")?t.getAttribute("trustexpired"):0,o=t&&t.getAttribute("trustlabel")?t.getAttribute("trustlabel"):"",n={otp:"",username:e};return openURL(getchromeurl("lp_toolstrip.html?browseraction=1&sesame=1&trustexpired="+encodeURIComponent(r)+"&trustlabel="+encodeURIComponent(o))),n.otp}function sesame_setdata(e,t){lpsesamedata[e]=t}function sesame_getdata(e){return void 0===lpsesamedata[e]?null:lpsesamedata[e]}function sesame_cleardata(){lpdbg("sesame","clearing data"),lpsesamedata={}}function sesame_auth(e,t){if(grid_setdata("active",null),""!=e){if("1"==sesame_getdata("offline"))return sesame_setdata("password_offline",e),offlineloginsuccessful("offline",0),lpReadAcctsData(),void sesame_setdata("offline","0");var a=null,r=null,o=null,n=null;sesame_getdata("postdata")?(a=sesame_getdata("postdata")+"&sesameotp="+encodeURIComponent(e),r="login.php",o=lpLoginResponse,n=lpLoginError):(a=sesame_getdata("logincheckpostdata")+"&sesameotp="+encodeURIComponent(e),r="login_check.php",o=lpLoginCheckResponse,n=lpLoginCheckError),""!=t&&(a+="&trustlabel="+encodeURIComponent(t));var s=sesame_getdata("fromwebsite");console_log("server.js : Requesting "+r+" D"),lpMakeRequest(base_url+r,a,o,n,s)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"sesame_auth_error")}function grid_getvalues(e,t,a){grid_setdata("active","1"),openURL(getchromeurl("lp_toolstrip.html?browseraction=1&grid=1&trustexpired="+encodeURIComponent(a.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(a.getAttribute("trustlabel"))+"&challenge="+encodeURIComponent(t)))}function grid_setdata(e,t){lpgriddata[e]=t}function grid_getdata(e){return void 0===lpgriddata[e]?null:lpgriddata[e]}function grid_cleardata(){lpdbg("grid","clearing data"),lpgriddata={}}function grid_auth(e,t){if(grid_setdata("active",null),""!=e){var a=null,r=null,o=null,n=null;grid_getdata("postdata")?(a=grid_getdata("postdata")+"&gridresponse="+encodeURIComponent(e),r="login.php",o=lpLoginResponse,n=lpLoginError):(a=sesame_getdata("logincheckpostdata")+"&gridresponse="+encodeURIComponent(e),r="login_check.php",o=lpLoginCheckResponse,n=lpLoginCheckError),""!=t&&(a+="&trustlabel="+encodeURIComponent(t)),grid_getdata("wxsessid")&&(a+="&wxsessid="+encodeURIComponent(grid_getdata("wxsessid")));var s=grid_getdata("fromwebsite");console_log("server.js : Requesting "+r+" E"),lpMakeRequest(base_url+r,a,o,n,s)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"grid_auth_error")}function multifactor_getresponse(e,t){var a="";multifactor_setdata("active","1");var r=multifactor_getdata("type"),o="";multifactor_getdata("type")==r&&(o=multifactor_getdata("password_offline")),o&&64==o.length||(o=SHA256(SHA256(fix_username(e)+r)));var n=function(){if(multifactor_setdata("password_offline",o),multifactor_setdata("type",r),t){if("omnikey"==r)return void omnikey_get_pin(function(e){have_binary_function("omnikey_decrypt")?call_binary_function("omnikey_decrypt",t,e,function(e){a=e,multifactor_auth(a,"")}):multifactor_auth(a,"")});a=""!=o?SHA256(o+t):""}else a=o;multifactor_auth(a,"")};if((!o||64!=o.length)&&"trueapi"==r&&have_binary_function("trueapi_get_hash"))return void call_binary_function("trueapi_get_hash",e,function(e){o=e,n()});n()}function multifactor_setdata(e,t){lpmultifactordata[e]=t}function multifactor_getdata(e){return void 0===lpmultifactordata[e]?null:lpmultifactordata[e]}function multifactor_cleardata(){lpdbg("multifactor","clearing data"),lpmultifactordata={}}function multifactor_auth(e,t){if(multifactor_setdata("active",null),""!=e){if("1"==multifactor_getdata("offline"))return multifactor_setdata("password_offline",e),"omnikey"!=multifactor_getdata("type")&&multifactor_setdata("type","trueapi"),offlineloginsuccessful("offline",0),lpReadAcctsData(),void multifactor_setdata("offline","0");var a=null,r=null,o=null,n=null;multifactor_getdata("postdata")?(a=multifactor_getdata("postdata")+"&multifactorresponse="+encodeURIComponent(e),r="login.php",o=lpLoginResponse,n=lpLoginError):(a=sesame_getdata("logincheckpostdata")+"&multifactorresponse="+encodeURIComponent(e),r="login_check.php",o=lpLoginCheckResponse,n=lpLoginCheckError),""!=t&&(a+="&trustlabel="+encodeURIComponent(t)),multifactor_getdata("wxsessid")&&(a+="&wxsessid="+encodeURIComponent(multifactor_getdata("wxsessid"))),multifactor_getdata("type")&&(a+="&type="+encodeURIComponent(multifactor_getdata("type")));var s=multifactor_getdata("fromwebsite");console_log("server.js : Requesting "+r+" F"),lpMakeRequest(base_url+r,a,o,n,s)}else lpshowError("LoginError",!1,!0,!1,get_multifactor_disable_url(g_username,multifactor_getdata("type"))),loggedOut(!1,"multifactor_auth_error")}function multifactor_response(e,t){lpdbg("multifactor","in multifactor_response"),void 0!==e.callback?(lpdbg("multifactor","calling callback"),e.callback(t)):sendCS(e.tabid,t,e.docnum)}function lpSetupMultifactorResponse(e,t,a){if(lpdbg("multifactor","setupmultifactorresponse: "+e.readyState),4==e.readyState){if(lpdbg("multifactor","setupmultifactorresponse: "+e.status),200==e.status&&null!=e.responseXML&&null!=e.responseXML.documentElement){var r=e.responseXML.documentElement,o=r.getElementsByTagName("ok");if(o.length>0){var n=o[0].getAttribute("type");lpdbg("multifactor","setupmultifactorresponse: "+n);var s=o[0].getAttribute("hash");if("trueapi"==n){if(void 0!==a.password){if(have_binary_function("trueapi_store_default_login"))return void call_binary_function("trueapi_store_hash",g_username,s,function(e){if(e){var t=function(e){e==s?call_binary_function("trueapi_store_default_login",g_username,a.password,s,function(e){e?(setsinglefactortype(n),"1"!=a.silent&&multifactor_response(a,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(a)}):lpSetupMultifactorError(a)};"1"==a.silent?t(s):call_binary_function("trueapi_get_hash",g_username,function(e){t(e)})}else lpSetupMultifactorError(a)})}else if("1"!=a.silent&&have_binary_function("trueapi_store_hash"))return void call_binary_function("trueapi_store_hash",g_username,s,function(e){e?call_binary_function("trueapi_get_hash",g_username,function(e){e==s?multifactor_response(a,{cmd:"setupmultifactor",result:"done"}):lpSetupMultifactorError(a)}):lpSetupMultifactorError(a)})}else if("vtapi"==n){if(have_binary_function("lpvt_store_data"))return void call_binary_function("lpvt_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(a.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),gs("Swipe current user's finger"),function(e){e?(setsinglefactortype(n),"1"!=a.silent&&multifactor_response(a,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(a)})}else if("validity"==n){if(have_binary_function("validity_store_data"))return void call_binary_function("validity_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(a.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),function(e){e?(setsinglefactortype(n),"1"!=a.silent&&multifactor_response(a,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(a)})}else if("winbio"==n){if(have_binary_function("winbio_store_data"))return void call_binary_function("winbio_has_fingerprints",function(e){lpdbg("multifactor","winbio_has_fingerprints: "+e),e?call_binary_function("winbio_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(a.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),function(e){lpdbg("multifactor","winbio_store_data: "+e),e?(setsinglefactortype(n),"1"!=a.silent&&(lpdbg("multifactor","calling multifactor_response"),multifactor_response(a,{cmd:"setupsinglefactor",result:"done"}))):lpSetupMultifactorError(a)}):(have_binary_function("winbio_launch_enrollment")&&call_binary_function("winbio_launch_enrollment"),"1"!=a.silent&&multifactor_response(a,{cmd:"setupsinglefactor",result:"notenrolled"}))})}else{if("nymi"==n)return void(have_binary_function("nymi_provision")&&call_binary_function("nymi_provision",encodeURIComponent(g_username)+"|"+encodeURIComponent(a.password),function(e){lpdbg("multifactor","nymi_provision: "+e),e?(setsinglefactortype(n),"1"!=a.silent&&(lpdbg("multifactor","calling multifactor_response"),call_binary_function("nymi_read_data",function(e){multifactor_response(a,{cmd:"setupsinglefactor",result:"done_"+e})}))):lpSetupMultifactorError(a)}));if("omnikey"==n)return void multifactor_response(a,{cmd:"setupsinglefactor",result:"done"})}}}lpSetupMultifactorError(a)}}function lpSetupMultifactorError(e){1!=e.silent&&multifactor_response(e,{cmd:void 0!==e.password?"setupsinglefactor":"setupmultifactor",result:"error"})}function get_multifactor_disable_url(e,t){return"multifactordisable.php?cmd=sendemail&username="+en(e)+"&type="+en(t)}function lp_StartLogin(e,t){console_log("server.js : lp_StartLogin fromlogincheckack="+e),g_loginstarted||(g_loginstarted=!0,e?(rsa_setpendingsharests(),lplogincheck("frompipes",t)):httptest())}function can_chrome_do_math(){var e;return 33890436==(46512102&(e=2600822924))&&0!=e&&"cf80cd8aed482d5d1527d7dc72fceff84e6326592848447d2dc0b0e87dfc9a90"==SHA256("testing")}function lpDownloadDataResponse(e,t,a){if(e&&200==e.status&&4==e.readyState){for(var r=e.responseText,o="",n=r.split("\n"),s=0;s<n.length;s++)if(0==n[s].indexOf("ff_")){var i=n[s].indexOf("=");if(-1!=i){var l=n[s].substr(0,i),g=n[s].substr(i+1);g=CheckStringForObfuscation(l,"",g),o+=l+"="+g+"\n"}}else o+=n[s]+"\n";localStorage_setItem(a,o),"ff.dat"==a?ApplyAllOverrides():"sites.dat"==a?LoadSpecialSites():"bigicon.dat"==a&&LoadBigIconList()}}function checkIterationsInDataFile(e){var t=get_key_iterations(g_username),a=e.substring(0,20);if(0==a.indexOf("iterations=")){var r=/iterations=(\d*);/,o=r.exec(a);return o.length>1&&t==o[1]?e.substring(e.indexOf(";")+1):"iterationserror"}return 1!=t?"iterationserror":e}function prependIterations(e){var t=get_key_iterations(g_username);return t>1&&(e="iterations="+t+";"+e),e}function checkIterationsReductionOk(e){var t=SHA256(g_username),a=t+"_key_iter";if("undefined"!=typeof localStorage&&null!=localStorage_getItem(a)){if(localStorage_getItem(a)>e)return!g_checkiterationsreduction||confirm(gs("IterationsReduction"))}return!0}function pref_numeric_validate(e,t){var a=parseInt(e);return a<0||isNaN(a)?t:a}function sendLpImprove(e,t){if((!g_username||g_prompts.improve)&&e){var a=get_method?get_method():"",r=(new PostParams).add("cmd","lpimprove").add("event",e).add("method",a);if(t)for(var o in t)t.hasOwnProperty(o)&&r.add(o,t[o]);isDogfood()&&r.add("dogfood",1),lpMakeRequest(base_url+"lastpass/api.php",r.toString(),null,null)}}function isDogfood(){var e=!1;return g_ischrome&&chrome.runtime.getManifest()&&chrome.runtime.getManifest().short_name&&chrome.runtime.getManifest().short_name.toLowerCase().indexOf("dog")>-1&&(e=!0),e}var g_iterpw=null,jj="",allowmultifactortrust=!0,hidemultifactordisable=!1,lploginerrorhandlercalled=0,server_tries=0;generateSharingKeys=function(){var e=!1;return function(t){if(console_log("RSA : generateSharingKeys : generating="+e),!e)if(have_binary_function("xGenerateKeys")){console_log("RSA : generateSharingKeys : using xGenerateKeys"),e=!0;var a=AES.bin2hex(g_local_key).toUpperCase();call_binary_function("xGenerateKeys",a,function(e){console_log("RSA : generateSharingKeys : xGenerateKeys completed");var t=e.split("|");2==t.length?(console_log("RSA : generateSharingKeys : xGenerateKeys was successful -- calling upload_rsa_keys()"),upload_rsa_keys("xGenerateKeys",{privatekey:atob(t[0]),publickey:atob(t[1])})):console_log("RSA : generateSharingKeys : xGenerateKeys failed")})}else if(have_pplastpass()){e=!0;var a=AES.bin2hex(g_local_key).toUpperCase();console_log("RSA : generateSharingKeys : using xGenerateKeys via pplastpass"),pplastpass_send_message({cmd:"xGenerateKeys",userkeyhex:a},function(e){console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass completed");var t=e.split("|");2==t.length?(console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass was successful -- calling upload_rsa_keys()"),upload_rsa_keys("xGenerateKeys",{privatekey:atob(t[0]),publickey:atob(t[1])})):console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass failed")})}else if(g_ischrome){console_log("RSA : generateSharingKeys : using Javascript RSAKey() to create sharing keys"),e=!0;var r=new RSAKey;generate_key(r,function(e){console_log("RSA : generateSharingKeys : Javascript RSAKey() was successful -- calling upload_rsa_keys()"),upload_rsa_keys("RSAKey",e)})}else console_log("RSA : generateSharingKeys : Not generating keys since unsupported OS");t&&t(e)}}();var adminoverride="",lplastgetaccounts=0,PostParams=function(e){this.params={};for(var t in e)this.add(t,e[t])};!function(){PostParams.prototype.add=function(e,t,a){return!e||"string"!=typeof e||"boolean"!=typeof t&&"number"!=typeof t&&"string"!=typeof t||!a&&this.params.hasOwnProperty(e)||(this.params[e]=String(t)),this},PostParams.prototype.remove=function(e){return e&&"string"==typeof e&&this.params.hasOwnProperty(e)&&delete this.params[e],this},PostParams.prototype.clear=function(){return this.params={},this},PostParams.prototype.toString=function(){var e="";for(var t in this.params)this.params.hasOwnProperty(t)&&(""!=e&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(this.params[t]));return e}}(),fillGeneratedPassword=function(){var e=function(e,t,a,r){var o={cmd:"populategeneratedpassword",url:t,password:a};sendLpImprove("genpassword",r),sendCS(e,o)};return function(t,a,r,o){LPContentScriptFeatures.new_save_site?t?e(t,a,r,o):get_selected_tab_data(null,function(t){e(t.id,t.url,r,o)}):t?(g_checkgeneratepasswordcallback=function(){savePassword(r,a,t,!0,o)},checkgeneratepassword(t)):get_selected_tab_data(null,function(e){fillGeneratedPassword(e.id,e.url,r,o)})}}();var g_lastpoll=null,g_notifications=[],lpyubidata={},lpgoogleauthdata={},lpoutofbanddata={},g_last_otpcheck,g_otpcheck_complete=!1,g_otpwin_closed=!1,g_trustlabel="",lpsecurityquestiondata={},lpsesamedata={},lpsesameotp=null,lpgriddata={},lpgridvalues=null,lpmultifactordata={},lpmultifactorresponse=null;