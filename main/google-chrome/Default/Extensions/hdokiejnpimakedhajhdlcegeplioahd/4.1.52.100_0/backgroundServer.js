BackgroundServer=function(e){LPServer.initialize(e,{ajax:function(e){e.data&&(e.data.method=get_method()),LPPlatform.ajax(e)}});var r=function(e){return function(){e.apply(this,arguments),increment_local_accts_version(),rewritelocalfile()}},s=function(e,r,s){r instanceof Array?r.push(e):r[e[s]]=e},n=r(s),i=function(e,r,s){if(r instanceof Array){for(var n=0,i=r.length;n<i;++n)if(e[s]===r[n][s]){r[n]=e;break}}else r[e[s]]=e},t=r(i),a=function(e,r,s){if(e instanceof Array){for(var n=0,i=e.length;n<i;++n)if(s===e[n][r]){e.splice(n,1);break}}else delete e[r]},c=r(a),o=function(e,r,s){if(!(e instanceof Array))return e[r];for(var n=0,i=e.length;n<i;++n)if(s===e[n][r])return e[n]};return{emergencyAccess:{updateRecipient:function(e){var r=e.success;e.success=function(s){t(e.params.recipient,g_emer_sharees,"username"),r(e.params.recipient)},LPServer.emergencyAccess.updateRecipient(e)},addRecipient:function(e){var r=e.success;e.success=function(s){n(e.params.recipient,g_emer_sharees,"username"),r(e.params.recipient)},LPServer.emergencyAccess.addRecipient(e)},removeRecipient:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_emer_sharees,"username",e.params.id)}),LPServer.emergencyAccess.removeRecipient(e)},getRecipientInfo:function(e){LPServer.emergencyAccess.getRecipientInfo(e)},getSharerInfo:function(e){LPServer.emergencyAccess.getSharerInfo(e)},acceptOffer:function(e){var r=e.success;e.success=function(){var s=e.params.sharer;s.accepted="1",t(s,g_emer_sharers,"username"),r(s)},LPServer.emergencyAccess.acceptOffer(e)},declineOffer:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_emer_sharers,"username",e.params.email)}),LPServer.emergencyAccess.declineOffer(e)},requestAccess:function(e){e.callbacks=e.callbacks||{};var r=e.callbacks.successLinked;e.callbacks.successLinked=function(e,s){var n=s.params.sharer;n.confirmed="1",n.allowed_access="1",n.linked="1",n.override_date=new Date,refreshsites(),r&&r(n,s)};var s=e.callbacks.successGranted;e.callbacks.successGranted=function(e,r){var n=r.params.sharer;n.confirmed="1",n.override_date=new Date,n.override_date.setTime(n.override_date.getTime()+60*n.hours_to_override*60*1e3),s&&s(n,r)},LPServer.emergencyAccess.requestAccess(e)},denyAccess:function(e){e.success=LPServer.extendCallback(e.success,function(){var r=o(g_emer_sharees,"username",e.params.email);r.confirmed="0",r.allowed_access="0"}),LPServer.emergencyAccess.denyAccess(e)},unlinkAccount:function(e){e.success=LPServer.extendCallback(e.success,r(function(){if(e.params.folderID)delete g_sites[e.params.folderID];else for(var r in g_sites){var s=g_sites[r];if("http://group"===s.url&&s.group===e.params.email){delete g_sites[r];break}}})),LPServer.emergencyAccess.unlinkAccount(e)}},identities:{add:function(e){var r=e.success;e.success=function(s){var i=e.params.identity;i.iid=LPServer.getAttr(s,"iid",""),n(i,g_identities,"iid"),r(i)},LPServer.identities.add(e)},remove:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_identities,"iid",e.params.id)}),LPServer.identities.remove(e)},update:function(e){var r=e.success;e.success=function(){var s=e.params.identity;t(s,g_identities,"iid"),r(s)},LPServer.identities.update(e)}},vault:{history:{revertPasswordChange:function(){LPServer.vault.history.revertPasswordChange.apply(this,arguments)},getPasswordHistory:function(){LPServer.vault.history.getPasswordHistory.apply(this,arguments)},getUsernameHistory:function(){LPServer.vault.history.getUsernameHistory.apply(this,arguments)},getNoteHistory:function(){LPServer.vault.history.getNoteHistory.apply(this,arguments)}}},sharing:{individual:{shareItems:function(e){LPServer.sharing.individual.shareItems(e)},unshareItem:function(e){LPServer.sharing.individual.unshareItem(e)},acceptShare:function(e){e.success=LPServer.extendCallback(e.success,function(){refreshsites()}),LPServer.sharing.individual.acceptShare(e)},rejectShare:function(e){e.success=LPServer.extendCallback(e.success,function(){c(g_pendings,"id",e.params.id)}),LPServer.sharing.individual.rejectShare(e)},inviteFriends:function(e){LPServer.sharing.individual.inviteFriends(e)},getSentShareData:function(e){LPServer.sharing.individual.getSentShareData(e)},getReceivedShareData:function(e){LPServer.sharing.individual.getReceivedShareData(e)}},folder:{getFolders:function(e){LPServer.sharing.folder.getFolders(e)},getPublicKeys:function(e){LPServer.sharing.folder.getPublicKeys(e)},create:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){r.shareInfo.sharekeyaes=lpmenc(AES.bin2hex(r.shareInfo.key),!0,g_local_key),s(r.shareInfo,g_shares,"id"),s(r.sharedFolder,g_sites,"aid")})),e.params.username=g_username,LPServer.sharing.folder.create(e)},rename:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){i(r.shareInfo,g_shares,"id"),i(r.sharedFolder,g_sites,"aid")})),LPServer.sharing.folder.rename(e)},remove:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){i(r.shareInfo,g_shares,"id");for(var s in g_sites){g_sites[s].sharefolderid===r.shareInfo.id&&delete g_sites[s]}})),LPServer.sharing.folder.remove(e)},accept:function(e){e.success=LPServer.extendCallback(e.success,function(){a(g_pending_shares,"id",e.params.shareInfo.id),refreshsites()}),LPServer.sharing.folder.accept(e)},reject:function(e){e.success=LPServer.extendCallback(e.success,r(function(){a(g_pending_shares,"id",e.params.shareInfo.id)})),LPServer.sharing.folder.reject(e)},addMembers:function(e){LPServer.sharing.folder.addMembers(e)},getMembers:function(e){LPServer.sharing.folder.getMembers(e)},removeMember:function(e){LPServer.sharing.folder.removeMember(e)},reinviteMember:function(e){LPServer.sharing.folder.reinviteMember(e)},updateMemberPermissions:function(e){LPServer.sharing.folder.updateMemberPermissions(e)},getRestrictions:function(e){LPServer.sharing.folder.getRestrictions(e)},updateRestrictions:function(e){LPServer.sharing.folder.updateRestrictions(e)},startDownloading:function(e){e.success=LPServer.extendCallback(e.success,function(e,r){refreshsites()}),LPServer.sharing.folder.startDownloading(e)},stopDownloading:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){i(r.shareInfo,g_shares,"id");for(var s in g_sites){g_sites[s].sharefolderid===r.shareInfo.id&&delete g_sites[s]}})),LPServer.sharing.folder.stopDownloading(e)},restoreDeleted:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){i(r.shareInfo,g_shares,"id"),refreshsites()})),LPServer.sharing.folder.restoreDeleted(e)},purgeDeleted:function(e){e.success=LPServer.extendCallback(e.success,r(function(){a(g_shares,"id",e.params.shareid),a(g_sites,"aid",e.params.shareid)})),LPServer.sharing.folder.purgeDeleted(e)},convertToEnterprise:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){i(r.shareInfo,g_shares,"id"),i(r.sharedFolder,g_sites,"aid")})),LPServer.sharing.folder.convertToEnterprise(e)}}},sitesAndNotes:{saveCustomNoteTemplate:function(e){e.success=LPServer.extendCallback(e.success,r(function(e,r){s(r,g_note_templates,"id")})),LPServer.sitesAndNotes.saveCustomNoteTemplate(e)},deleteCustomNoteTemplate:function(e){e.success=LPServer.extendCallback(e.success,r(function(r,s){a(g_note_templates,"id",e.params.id)})),LPServer.sitesAndNotes.deleteCustomNoteTemplate(e)}},transact:{sendReminder:function(e){LPServer.transact.sendReminder(e)}}}}(this);